/*
 * This file is part of Dependency-Track.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 * Copyright (c) OWASP Foundation. All Rights Reserved.
 */
package org.dependencytrack.resources.v1;

import alpine.common.util.UuidUtil;
import alpine.server.filters.ApiFilter;
import alpine.server.filters.AuthenticationFeature;
import net.javacrumbs.jsonunit.core.Option;
import org.dependencytrack.JerseyTestRule;
import org.dependencytrack.ResourceTest;
import org.dependencytrack.model.AffectedVersionAttribution;
import org.dependencytrack.model.AnalysisJustification;
import org.dependencytrack.model.AnalysisResponse;
import org.dependencytrack.model.AnalysisState;
import org.dependencytrack.model.AnalyzerIdentity;
import org.dependencytrack.model.Component;
import org.dependencytrack.model.ConfigPropertyConstants;
import org.dependencytrack.model.Project;
import org.dependencytrack.model.Severity;
import org.dependencytrack.model.Tag;
import org.dependencytrack.model.Vulnerability;
import org.dependencytrack.model.VulnerableSoftware;
import org.dependencytrack.persistence.jdbi.AnalysisDao;
import org.glassfish.jersey.server.ResourceConfig;
import org.junit.Assert;
import org.junit.ClassRule;
import org.junit.Test;

import jakarta.json.Json;
import jakarta.json.JsonArray;
import jakarta.json.JsonObject;
import jakarta.ws.rs.client.Entity;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;
import java.util.List;
import java.util.Set;
import java.util.UUID;
import java.util.function.Supplier;

import static net.javacrumbs.jsonunit.assertj.JsonAssertions.assertThatJson;
import static org.assertj.core.api.Assertions.assertThat;
import static org.dependencytrack.persistence.jdbi.JdbiFactory.withJdbiHandle;
import static org.hamcrest.CoreMatchers.equalTo;

public class VulnerabilityResourceTest extends ResourceTest {

    @ClassRule
    public static JerseyTestRule jersey = new JerseyTestRule(
            new ResourceConfig(VulnerabilityResource.class)
                    .register(ApiFilter.class)
                    .register(AuthenticationFeature.class));

    @Test
    public void getVulnerabilitiesByComponentUuidTest() {
        SampleData sampleData = new SampleData();
        Response response = jersey.target(V1_VULNERABILITY + "/component/" + sampleData.c1.getUuid().toString()).request()
                .header(X_API_KEY, apiKey)
                .get(Response.class);
        Assert.assertEquals(200, response.getStatus(), 0);
        Assert.assertEquals(String.valueOf(2), response.getHeaderString(TOTAL_COUNT_HEADER));
        assertThatJson(getPlainTextBody(response)).isEqualTo("""
                [
                    {
                        "vulnId": "INT-1",
                        "source": "INTERNAL",
                        "description": "Description 1",
                        "severity": "CRITICAL",
                        "cwes": [
                          {
                            "cweId": 123,
                            "name": "Write-what-where Condition"
                          }
                        ],
                        "tags":[
                            {
                                "name":"internal_tag"
                            }
                         ],
                        "uuid": "${json-unit.any-string}",
                        "affectedProjectCount": 1,
                        "affectedActiveProjectCount": 1,
                        "affectedInactiveProjectCount": 0
                    },
                    {
                        "vulnId": "INT-2",
                        "source": "INTERNAL",
                        "description": "Description 2",
                        "severity": "HIGH",
                        "cwes": [
                          {
                            "cweId": 321,
                            "name": "Use of Hard-coded Cryptographic Key"
                          }
                        ],
                        "uuid": "${json-unit.any-string}",
                        "affectedProjectCount": 1,
                        "affectedActiveProjectCount": 1,
                        "affectedInactiveProjectCount": 0
                    }
                ]
                """);
    }

    @Test
    public void getVulnerabilitiesByComponentInvalidTest() {
        new SampleData();
        Response response = jersey.target(V1_VULNERABILITY + "/component/" + UUID.randomUUID()).request()
                .header(X_API_KEY, apiKey)
                .get(Response.class);
        Assert.assertEquals(404, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The component could not be found.", body);
    }

    @Test
    public void getVulnerabilitiesByComponentUuidIncludeSuppressedTest() {
        SampleData sampleData = new SampleData();
        Response response = jersey.target(V1_VULNERABILITY + "/component/" + sampleData.c1.getUuid().toString())
                .queryParam("suppressed", "true")
                .request()
                .header(X_API_KEY, apiKey)
                .get(Response.class);
        Assert.assertEquals(200, response.getStatus(), 0);
        Assert.assertEquals(String.valueOf(3), response.getHeaderString(TOTAL_COUNT_HEADER));
        assertThatJson(getPlainTextBody(response)).isEqualTo("""
                [
                     {
                         "vulnId": "INT-1",
                         "source": "INTERNAL",
                         "description": "Description 1",
                         "severity": "CRITICAL",
                         "cwes": [
                           {
                             "cweId": 123,
                             "name": "Write-what-where Condition"
                           }
                         ],
                         "tags":[
                            {
                                "name":"internal_tag"
                            }
                         ],
                         "uuid": "${json-unit.any-string}",
                         "affectedProjectCount": 1,
                         "affectedActiveProjectCount": 1,
                         "affectedInactiveProjectCount": 0
                     },
                     {
                         "vulnId": "INT-2",
                         "source": "INTERNAL",
                         "description": "Description 2",
                         "severity": "HIGH",
                         "cwes": [
                           {
                             "cweId": 321,
                             "name": "Use of Hard-coded Cryptographic Key"
                           }
                         ],
                         "uuid": "${json-unit.any-string}",
                         "affectedProjectCount": 1,
                         "affectedActiveProjectCount": 1,
                         "affectedInactiveProjectCount": 0
                     },
                     {
                         "vulnId": "INT-3",
                         "source": "INTERNAL",
                         "description": "Description 3",
                         "severity": "MEDIUM",
                         "uuid": "${json-unit.any-string}",
                         "affectedProjectCount": 1,
                         "affectedActiveProjectCount": 1,
                         "affectedInactiveProjectCount": 0
                     }
                 ]
                """);
    }

    @Test
    public void getVulnerabilitiesByProjectTest() {
        SampleData sampleData = new SampleData();
        Response response = jersey.target(V1_VULNERABILITY + "/project/" + sampleData.p1.getUuid().toString()).request()
                .header(X_API_KEY, apiKey)
                .get(Response.class);
        Assert.assertEquals(200, response.getStatus(), 0);
        Assert.assertEquals(String.valueOf(4), response.getHeaderString(TOTAL_COUNT_HEADER));
        assertThatJson(getPlainTextBody(response)).isEqualTo("""
                [
                     {
                         "vulnId": "INT-1",
                         "source": "INTERNAL",
                         "description": "Description 1",
                         "severity": "CRITICAL",
                         "cwes": [
                           {
                             "cweId": 123,
                             "name": "Write-what-where Condition"
                           }
                         ],
                         "tags":[
                            {
                                "name":"internal_tag"
                            }
                         ],
                         "components": [
                             {
                                 "name": "Component 1",
                                 "purl":"pkg:maven/com.example/component-1@1.0.0",
                                 "md5": "2aaf520d1f19aecf246a0995d91e93a5",
                                 "sha1": "3d5a54669cf8d4ed55b7df5751fa18c3f72f0cfb",
                                 "sha256": "47602d7dfe910ad941fea52e85e6e3f1c175434b0e6e261c31c766fe4c078a25",
                                 "uuid": "${json-unit.any-string}",
                                 "expandDependencyGraph": false,
                                 "isInternal": false,
                                 "externalReferences":[]
                             }
                         ],
                         "uuid": "${json-unit.any-string}",
                         "affectedInactiveProjectCount": 0,
                         "affectedProjectCount": 0,
                         "affectedActiveProjectCount": 0
                     },
                     {
                         "vulnId": "INT-2",
                         "source": "INTERNAL",
                         "description": "Description 2",
                         "severity": "HIGH",
                         "cwes": [
                           {
                             "cweId": 321,
                             "name": "Use of Hard-coded Cryptographic Key"
                           }
                         ],
                         "components": [
                             {
                                 "name": "Component 1",
                                 "purl":"pkg:maven/com.example/component-1@1.0.0",
                                 "md5": "2aaf520d1f19aecf246a0995d91e93a5",
                                 "sha1": "3d5a54669cf8d4ed55b7df5751fa18c3f72f0cfb",
                                 "sha256": "47602d7dfe910ad941fea52e85e6e3f1c175434b0e6e261c31c766fe4c078a25",
                                 "uuid": "${json-unit.any-string}",
                                 "expandDependencyGraph": false,
                                 "isInternal": false,
                                 "externalReferences":[]
                             }
                         ],
                         "uuid": "${json-unit.any-string}",
                         "affectedInactiveProjectCount": 0,
                         "affectedProjectCount": 0,
                         "affectedActiveProjectCount": 0
                     },
                     {
                         "vulnId": "INT-4",
                         "source": "INTERNAL",
                         "description": "Description 4",
                         "severity": "LOW",
                         "cwes": [
                           {
                             "cweId": 123,
                             "name": "Write-what-where Condition"
                           },
                           {
                             "cweId": 321,
                             "name": "Use of Hard-coded Cryptographic Key"
                           }
                         ],
                         "components": [
                             {
                                 "name": "Component 2",
                                 "purl":"pkg:maven/com.example/component-2@2.0.0",
                                 "md5": "5eabd62fa03d159a96c77e6eeb6c7027",
                                 "sha1": "108bcf94a1c0e0f915b935c97f6bb9e50fb7c246",
                                 "sha256": "418716b003fe0268b6521ef7acbed13f5ba491d593896d5deb2058c42d87002d",
                                 "uuid": "${json-unit.any-string}",
                                 "expandDependencyGraph": false,
                                 "isInternal": false,
                                 "externalReferences":[]
                             }
                         ],
                         "uuid": "${json-unit.any-string}",
                         "affectedInactiveProjectCount": 0,
                         "affectedProjectCount": 0,
                         "affectedActiveProjectCount": 0
                     },
                     {
                         "vulnId": "INT-5",
                         "source": "INTERNAL",
                         "description": "Description 5",
                         "severity": "CRITICAL",
                         "components": [
                             {
                                 "name": "Component 2",
                                 "purl":"pkg:maven/com.example/component-2@2.0.0",
                                 "md5": "5eabd62fa03d159a96c77e6eeb6c7027",
                                 "sha1": "108bcf94a1c0e0f915b935c97f6bb9e50fb7c246",
                                 "sha256": "418716b003fe0268b6521ef7acbed13f5ba491d593896d5deb2058c42d87002d",
                                 "uuid": "${json-unit.any-string}",
                                 "expandDependencyGraph": false,
                                 "isInternal": false,
                                 "externalReferences":[]
                             }
                         ],
                         "uuid": "${json-unit.any-string}",
                         "affectedInactiveProjectCount": 0,
                         "affectedProjectCount": 0,
                         "affectedActiveProjectCount": 0
                     }
                 ]
                """);
    }

    @Test
    public void getVulnerabilitiesByProjectIncludeProjectSuppressedTest() {
        SampleData sampleData = new SampleData();
        Response response = jersey.target(V1_VULNERABILITY + "/project/" + sampleData.p2.getUuid().toString())
                .queryParam("suppressed", "true")
                .request()
                .header(X_API_KEY, apiKey)
                .get(Response.class);
        Assert.assertEquals(200, response.getStatus(), 0);
        Assert.assertEquals(String.valueOf(2), response.getHeaderString(TOTAL_COUNT_HEADER));
        assertThatJson(getPlainTextBody(response)).isEqualTo("""
            [
                {
                    "vulnId": "INT-4",
                    "source": "INTERNAL",
                    "description": "Description 4",
                    "severity": "LOW",
                    "cwes": [
                      {
                        "cweId": 123,
                        "name": "Write-what-where Condition"
                      },
                      {
                        "cweId": 321,
                        "name": "Use of Hard-coded Cryptographic Key"
                      }
                    ],
                    "components": [
                        {
                            "name": "Component 2",
                            "purl":"pkg:maven/com.example/component-2@2.0.0",
                            "md5": "5eabd62fa03d159a96c77e6eeb6c7027",
                            "sha1": "108bcf94a1c0e0f915b935c97f6bb9e50fb7c246",
                            "sha256": "418716b003fe0268b6521ef7acbed13f5ba491d593896d5deb2058c42d87002d",
                            "uuid": "${json-unit.any-string}",
                            "expandDependencyGraph": false,
                            "isInternal": false,
                            "externalReferences":[]
                        }
                    ],
                    "uuid": "${json-unit.any-string}",
                    "affectedInactiveProjectCount": 0,
                    "affectedProjectCount": 0,
                    "affectedActiveProjectCount": 0
                },
                {
                    "vulnId": "INT-5",
                    "source": "INTERNAL",
                    "description": "Description 5",
                    "severity": "CRITICAL",
                    "components": [
                        {
                            "name": "Component 2",
                            "purl":"pkg:maven/com.example/component-2@2.0.0",
                            "md5": "5eabd62fa03d159a96c77e6eeb6c7027",
                            "sha1": "108bcf94a1c0e0f915b935c97f6bb9e50fb7c246",
                            "sha256": "418716b003fe0268b6521ef7acbed13f5ba491d593896d5deb2058c42d87002d",
                            "uuid": "${json-unit.any-string}",
                            "expandDependencyGraph": false,
                            "isInternal": false,
                            "externalReferences":[]
                        }
                    ],
                    "uuid": "${json-unit.any-string}",
                    "affectedInactiveProjectCount": 0,
                    "affectedProjectCount": 0,
                    "affectedActiveProjectCount": 0
                }
            ]
            """);
    }

    @Test
    public void getVulnerabilitiesByProjectInvalidTest() {
        new SampleData();
        Response response = jersey.target(V1_VULNERABILITY + "/project/" + UUID.randomUUID().toString()).request()
                .header(X_API_KEY, apiKey)
                .get(Response.class);
        Assert.assertEquals(404, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The project could not be found.", body);
    }

    @Test
    public void getVulnerabilityByUuidTest() {
        final var sampleData = new SampleData();

        final Response response = jersey.target(V1_VULNERABILITY + "/" + sampleData.v1.getUuid()).request()
                .header(X_API_KEY, apiKey)
                .get();
        assertThat(response.getStatus()).isEqualTo(200);
        assertThat(response.getHeaderString(TOTAL_COUNT_HEADER)).isNull();
        assertThatJson(getPlainTextBody(response))
                .withOptions(Option.IGNORING_ARRAY_ORDER)
                .isEqualTo(/* language=JSON */ """
                        {
                          "vulnId": "INT-1",
                          "source": "INTERNAL",
                          "description": "Description 1",
                          "cwes": [
                            {
                              "cweId":123,
                              "name": "Write-what-where Condition"
                            }
                          ],
                          "tags":[
                            {
                                "name":"internal_tag"
                            }
                          ],
                          "severity": "CRITICAL",
                          "uuid": "${json-unit.any-string}",
                          "affectedComponents": [
                            {
                              "uuid": "${json-unit.any-string}",
                              "affectedVersionAttributions": [
                                {
                                  "firstSeen": "${json-unit.any-number}",
                                  "lastSeen": "${json-unit.any-number}",
                                  "source": "INTERNAL",
                                  "uuid": "${json-unit.any-string}"
                                }
                              ]
                            }
                          ],
                          "affectedProjectCount": 0,
                          "affectedActiveProjectCount": 0,
                          "affectedInactiveProjectCount": 0
                        }
                        """);
    }

    @Test
    public void getVulnerabilityByUuidInvalidTest() {
        new SampleData();
        Response response = jersey.target(V1_VULNERABILITY + "/" + UUID.randomUUID()).request()
                .header(X_API_KEY, apiKey)
                .get(Response.class);
        Assert.assertEquals(404, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The vulnerability could not be found.", body);
    }

    @Test
    public void getVulnerabilityByVulnIdTest() {
        final var sampleData = new SampleData();

        final Response response = jersey.target(V1_VULNERABILITY + "/source/" + sampleData.v1.getSource() + "/vuln/" + sampleData.v1.getVulnId()).request()
                .header(X_API_KEY, apiKey)
                .get();
        assertThat(response.getStatus()).isEqualTo(200);
        assertThat(response.getHeaderString(TOTAL_COUNT_HEADER)).isNull();
        assertThatJson(getPlainTextBody(response))
                .withOptions(Option.IGNORING_ARRAY_ORDER)
                .isEqualTo(/* language=JSON */ """
                        {
                          "vulnId": "INT-1",
                          "source": "INTERNAL",
                          "description": "Description 1",
                          "cwes": [
                            {
                              "cweId":123,
                              "name": "Write-what-where Condition"
                            }
                          ],
                          "tags":[
                            {
                                "name":"internal_tag"
                            }
                          ],
                          "severity": "CRITICAL",
                          "uuid": "${json-unit.any-string}",
                          "affectedComponents": [
                            {
                              "uuid": "${json-unit.any-string}",
                              "affectedVersionAttributions": [
                                {
                                  "firstSeen": "${json-unit.any-number}",
                                  "lastSeen": "${json-unit.any-number}",
                                  "source": "INTERNAL",
                                  "uuid": "${json-unit.any-string}"
                                }
                              ]
                            }
                          ],
                          "affectedProjectCount": 0,
                          "affectedActiveProjectCount": 0,
                          "affectedInactiveProjectCount": 0
                        }
                        """);
    }

    @Test
    public void getVulnerabilityByVulnIdInvalidTest() {
        new SampleData();
        Response response = jersey.target(V1_VULNERABILITY + "/source/INTERNAL/vuln/blah").request()
                .header(X_API_KEY, apiKey)
                .get(Response.class);
        Assert.assertEquals(404, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The vulnerability could not be found.", body);
    }

    @Test
    public void getAffectedProjectTest() {
        SampleData sampleData = new SampleData();
        Response response = jersey.target(V1_VULNERABILITY + "/source/" + sampleData.v1.getSource() + "/vuln/" + sampleData.v1.getVulnId() + "/projects").request()
                .header(X_API_KEY, apiKey)
                .get(Response.class);
        Assert.assertEquals(200, response.getStatus(), 0);
        Assert.assertEquals(String.valueOf(1), response.getHeaderString(TOTAL_COUNT_HEADER));
        assertThatJson(getPlainTextBody(response))
                .withMatcher("projectUuid", equalTo(sampleData.p1.getUuid().toString()))
                .withMatcher("componentUuid", equalTo(sampleData.c1.getUuid().toString()))
                .isEqualTo(/* language=JSON */ """
                        [
                          {
                            "active": true,
                            "affectedComponentUuids": [
                              "${json-unit.matches:componentUuid}"
                            ],
                            "dependencyGraphAvailable": false,
                            "name": "Project 1",
                            "uuid": "${json-unit.matches:projectUuid}",
                            "version": null
                          }
                        ]
                        """);
    }

    @Test
    public void getAffectedProjectWithVulnerabilityNotExistingTest() {
        new SampleData();
        Response response = jersey.target(V1_VULNERABILITY + "/source/INTERNAL/vuln/blah/projects").request()
                .header(X_API_KEY, apiKey)
                .get(Response.class);
        Assert.assertEquals(200, response.getStatus(), 0);
        Assert.assertEquals("0", response.getHeaderString(TOTAL_COUNT_HEADER));
        Assert.assertEquals("[]", getPlainTextBody(response));
    }

    @Test
    public void getAffectedProjectWithAclEnabledTest() {
        qm.createConfigProperty(
                ConfigPropertyConstants.ACCESS_MANAGEMENT_ACL_ENABLED.getGroupName(),
                ConfigPropertyConstants.ACCESS_MANAGEMENT_ACL_ENABLED.getPropertyName(),
                "true",
                ConfigPropertyConstants.ACCESS_MANAGEMENT_ACL_ENABLED.getPropertyType(),
                null
        );

        final var sampleData = new SampleData();
        sampleData.p2.setAccessTeams(Set.of(team));
        qm.persist(sampleData.p2);

        final Response response = jersey.target(V1_VULNERABILITY + "/source/" + sampleData.v4.getSource() + "/vuln/" + sampleData.v4.getVulnId() + "/projects").request()
                .header(X_API_KEY, apiKey)
                .get(Response.class);
        Assert.assertEquals(200, response.getStatus(), 0);
        Assert.assertEquals(String.valueOf(1), response.getHeaderString(TOTAL_COUNT_HEADER));
        assertThatJson(getPlainTextBody(response))
                .withMatcher("projectUuid", equalTo(sampleData.p2.getUuid().toString()))
                .withMatcher("componentUuid", equalTo(sampleData.c3.getUuid().toString()))
                .isEqualTo(/* language=JSON */ """
                        [
                          {
                            "uuid": "${json-unit.matches:projectUuid}",
                            "dependencyGraphAvailable": false,
                            "name": "Project 2",
                            "version": null,
                            "active": true,
                            "affectedComponentUuids": [
                              "${json-unit.matches:componentUuid}"
                            ]
                          }
                        ]
                        """);
    }

    @Test
    public void getAllVulnerabilitiesTest() {
        new SampleData();
        Response response = jersey.target(V1_VULNERABILITY).request()
                .header(X_API_KEY, apiKey)
                .get(Response.class);
        Assert.assertEquals(200, response.getStatus(), 0);
        Assert.assertEquals(String.valueOf(5), response.getHeaderString(TOTAL_COUNT_HEADER));
        JsonArray json = parseJsonArray(response);
        Assert.assertNotNull(json);
        Assert.assertEquals(5, json.size());
        Assert.assertEquals("INT-1", json.getJsonObject(0).getString("vulnId"));
        Assert.assertEquals(1, json.getJsonObject(0).getInt("affectedProjectCount"));
        Assert.assertNull(json.getJsonObject(0).getJsonObject("components"));
        Assert.assertEquals("INT-2", json.getJsonObject(1).getString("vulnId"));
        Assert.assertEquals(1, json.getJsonObject(1).getInt("affectedProjectCount"));
        Assert.assertNull(json.getJsonObject(1).getJsonObject("components"));
        Assert.assertEquals("INT-3", json.getJsonObject(2).getString("vulnId"));
        Assert.assertEquals(0, json.getJsonObject(2).getInt("affectedProjectCount"));
        Assert.assertNull(json.getJsonObject(2).getJsonObject("components"));
        Assert.assertEquals("INT-4", json.getJsonObject(3).getString("vulnId"));
        Assert.assertEquals(2, json.getJsonObject(3).getInt("affectedProjectCount"));
        Assert.assertNull(json.getJsonObject(3).getJsonObject("components"));
        Assert.assertEquals("INT-5", json.getJsonObject(4).getString("vulnId"));
        Assert.assertEquals(1, json.getJsonObject(4).getInt("affectedProjectCount"));
        Assert.assertNull(json.getJsonObject(4).getJsonObject("components"));
    }

    @Test
    public void getAllVulnerabilitiesWithAclEnabledTest() {
        qm.createConfigProperty(
                ConfigPropertyConstants.ACCESS_MANAGEMENT_ACL_ENABLED.getGroupName(),
                ConfigPropertyConstants.ACCESS_MANAGEMENT_ACL_ENABLED.getPropertyName(),
                "true",
                ConfigPropertyConstants.ACCESS_MANAGEMENT_ACL_ENABLED.getPropertyType(),
                null
        );

        final var sampleData = new SampleData();
        sampleData.p2.setAccessTeams(Set.of(team));
        qm.persist(sampleData.p2);

        Response response = jersey.target(V1_VULNERABILITY).request()
                .header(X_API_KEY, apiKey)
                .get(Response.class);
        Assert.assertEquals(200, response.getStatus(), 0);
        Assert.assertEquals(String.valueOf(5), response.getHeaderString(TOTAL_COUNT_HEADER));
        JsonArray json = parseJsonArray(response);
        Assert.assertNotNull(json);
        Assert.assertEquals(5, json.size());
        Assert.assertEquals("INT-1", json.getJsonObject(0).getString("vulnId"));
        Assert.assertEquals(0, json.getJsonObject(0).getInt("affectedProjectCount"));
        Assert.assertNull(json.getJsonObject(0).getJsonObject("components"));
        Assert.assertEquals("INT-2", json.getJsonObject(1).getString("vulnId"));
        Assert.assertEquals(0, json.getJsonObject(1).getInt("affectedProjectCount"));
        Assert.assertNull(json.getJsonObject(1).getJsonObject("components"));
        Assert.assertEquals("INT-3", json.getJsonObject(2).getString("vulnId"));
        Assert.assertEquals(0, json.getJsonObject(2).getInt("affectedProjectCount"));
        Assert.assertNull(json.getJsonObject(2).getJsonObject("components"));
        Assert.assertEquals("INT-4", json.getJsonObject(3).getString("vulnId"));
        Assert.assertEquals(1, json.getJsonObject(3).getInt("affectedProjectCount"));
        Assert.assertNull(json.getJsonObject(3).getJsonObject("components"));
        Assert.assertEquals("INT-5", json.getJsonObject(4).getString("vulnId"));
        Assert.assertEquals(0, json.getJsonObject(4).getInt("affectedProjectCount"));
        Assert.assertNull(json.getJsonObject(4).getJsonObject("components"));
    }

    @Test
    public void createVulnerabilityTest() {
        JsonObject payload = Json.createObjectBuilder()
                .add("vulnId", "ACME-1")
                .add("description", "Something is vulnerable")
                .add("cwes", Json.createArrayBuilder().add(Json.createObjectBuilder().add("cweId", 80)))
                .add("cvssV2Vector", "(AV:N/AC:M/Au:S/C:P/I:P/A:P)")
                .add("cvssV3Vector", "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L")
                .add("owaspRRVector", "SL:1/M:1/O:0/S:2/ED:1/EE:1/A:1/ID:1/LC:2/LI:1/LAV:1/LAC:1/FD:1/RD:1/NC:2/PV:3")
                .add("affectedComponents", Json.createArrayBuilder()
                        .add(Json.createObjectBuilder()
                                .add("identityType", "PURL")
                                .add("identity", "pkg:maven/com.acme/acme-app")
                                .add("versionType", "RANGE")
                                .add("versionEndIncluding", "1.2.3")))
                .build();
        Response response = jersey.target(V1_VULNERABILITY).request()
                .header(X_API_KEY, apiKey)
                .put(Entity.json(payload.toString()));
        Assert.assertEquals(201, response.getStatus(), 0);
        JsonObject json = parseJsonObject(response);
        Assert.assertNotNull(json);
        Assert.assertEquals("ACME-1", json.getString("vulnId"));
        Assert.assertEquals("INTERNAL", json.getString("source"));
        Assert.assertEquals("Something is vulnerable", json.getString("description"));
        Assert.assertEquals(6.0, json.getJsonNumber("cvssV2BaseScore").doubleValue(), 0);
        Assert.assertEquals(6.4, json.getJsonNumber("cvssV2ImpactSubScore").doubleValue(), 0);
        Assert.assertEquals(6.8, json.getJsonNumber("cvssV2ExploitabilitySubScore").doubleValue(), 0);
        Assert.assertEquals("(AV:N/AC:M/Au:S/C:P/I:P/A:P)", json.getString("cvssV2Vector"));
        Assert.assertEquals(6.3, json.getJsonNumber("cvssV3BaseScore").doubleValue(), 0);
        Assert.assertEquals(3.4, json.getJsonNumber("cvssV3ImpactSubScore").doubleValue(), 0);
        Assert.assertEquals(2.8, json.getJsonNumber("cvssV3ExploitabilitySubScore").doubleValue(), 0);
        Assert.assertEquals("CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L", json.getString("cvssV3Vector"));
        Assert.assertEquals(1.0, json.getJsonNumber("owaspRRLikelihoodScore").doubleValue(), 0);
        Assert.assertEquals(1.25, json.getJsonNumber("owaspRRTechnicalImpactScore").doubleValue(), 0);
        Assert.assertEquals(1.75, json.getJsonNumber("owaspRRBusinessImpactScore").doubleValue(), 0);
        Assert.assertEquals("SL:1/M:1/O:0/S:2/ED:1/EE:1/A:1/ID:1/LC:2/LI:1/LAV:1/LAC:1/FD:1/RD:1/NC:2/PV:3", json.getString("owaspRRVector"));
        Assert.assertEquals("MEDIUM", json.getString("severity"));
        Assert.assertEquals(1, json.getJsonArray("cwes").size());
        Assert.assertEquals(80, json.getJsonArray("cwes").getJsonObject(0).getInt("cweId"));
        Assert.assertEquals("Improper Neutralization of Script-Related HTML Tags in a Web Page (Basic XSS)", json.getJsonArray("cwes").getJsonObject(0).getString("name"));
        Assert.assertTrue(UuidUtil.isValidUUID(json.getString("uuid")));

        // Verify that VulnerableSoftware records and attributions thereof have been created correctly
        final Vulnerability vuln = qm.getVulnerabilityByVulnId(Vulnerability.Source.INTERNAL, "ACME-1");
        Assert.assertNotNull(vuln);
        Assert.assertEquals(1, vuln.getVulnerableSoftware().size());
        final List<AffectedVersionAttribution> attributions = qm.getAffectedVersionAttributions(vuln, vuln.getVulnerableSoftware().get(0));
        Assert.assertEquals(1, attributions.size());
        Assert.assertEquals(Vulnerability.Source.INTERNAL, attributions.get(0).getSource());
    }

    @Test
    public void createVulnerabilityWithBadOwaspVectorTest() {
        JsonObject payload = Json.createObjectBuilder()
                .add("vulnId", "ACME-1")
                .add("description", "Something is vulnerable")
                .add("cwes", Json.createArrayBuilder().add(Json.createObjectBuilder().add("cweId", 80)))
                .add("cvssV2Vector", "(AV:N/AC:M/Au:S/C:P/I:P/A:P)")
                .add("cvssV3Vector", "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L")
                .add("owaspRRVector", "SL:1/M:1/O:a/S:2/ED:1/EE:1/A:1/ID:1/LC:2/LI:1/LAV:1/LAC:1/FD:1/RD:1/NC:2/PV:3")
                .add("affectedComponents", Json.createArrayBuilder()
                        .add(Json.createObjectBuilder()
                                .add("identityType", "PURL")
                                .add("identity", "pkg:maven/com.acme/acme-app")
                                .add("versionType", "RANGE")
                                .add("versionEndIncluding", "1.2.3")))
                .build();
        Response response = jersey.target(V1_VULNERABILITY).request()
                .header(X_API_KEY, apiKey)
                .put(Entity.json(payload.toString()));
        Assert.assertEquals(400, response.getStatus(), 0);
        String body = getPlainTextBody(response);
        Assert.assertNotNull(body);
        Assert.assertEquals("Provided vector SL:1/M:1/O:a/S:2/ED:1/EE:1/A:1/ID:1/LC:2/LI:1/LAV:1/LAC:1/FD:1/RD:1/NC:2/PV:3 does not match OWASP RR Vector pattern SL:\\d/M:\\d/O:\\d/S:\\d/ED:\\d/EE:\\d/A:\\d/ID:\\d/LC:\\d/LI:\\d/LAV:\\d/LAC:\\d/FD:\\d/RD:\\d/NC:\\d/PV:\\d", body);
    }

    @Test
    public void createVulnerabilityDuplicateTest() {
        Vulnerability vuln = new Vulnerability();
        vuln.setVulnId("ACME-1");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        qm.createVulnerability(vuln, false);
        JsonObject payload = Json.createObjectBuilder()
                .add("vulnId", "ACME-1")
                .add("description", "Something is vulnerable")
                .add("cwes", Json.createArrayBuilder().add(Json.createObjectBuilder().add("cweId", 80)))
                .add("cvssV2Vector", "(AV:N/AC:M/Au:S/C:P/I:P/A:P)")
                .add("cvssV3Vector", "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L")
                .add("owaspRRVector", "SL:1/M:1/O:0/S:2/ED:1/EE:1/A:1/ID:1/LC:2/LI:1/LAV:1/LAC:1/FD:1/RD:1/NC:2/PV:3")
                .build();
        Response response = jersey.target(V1_VULNERABILITY).request()
                .header(X_API_KEY, apiKey)
                .put(Entity.json(payload.toString()));
        Assert.assertEquals(409, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("A vulnerability with the specified vulnId already exists.", body);
    }

    @Test
    public void updateVulnerabilityTest() {
        Vulnerability vuln = new Vulnerability();
        vuln.setVulnId("ACME-1");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        vuln = qm.createVulnerability(vuln, false);
        JsonObject payload = Json.createObjectBuilder()
                .add("vulnId", "ACME-1")
                .add("source", "INTERNAL")
                .add("description", "Something is vulnerable")
                .add("cwes", Json.createArrayBuilder().add(Json.createObjectBuilder().add("cweId", 80)))
                .add("cvssV2Vector", "(AV:N/AC:M/Au:S/C:P/I:P/A:P)")
                .add("cvssV3Vector", "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L")
                .add("owaspRRVector", "SL:1/M:1/O:0/S:2/ED:1/EE:1/A:1/ID:1/LC:2/LI:1/LAV:1/LAC:1/FD:1/RD:1/NC:2/PV:3")
                .add("tags", Json.createArrayBuilder().add(Json.createObjectBuilder().add("name", "vuln-tag")))
                .add("uuid", vuln.getUuid().toString())
                .build();
        Response response = jersey.target(V1_VULNERABILITY).request()
                .header(X_API_KEY, apiKey)
                .post(Entity.json(payload.toString()));
        Assert.assertEquals(200, response.getStatus(), 0);
        JsonObject json = parseJsonObject(response);
        Assert.assertNotNull(json);
        Assert.assertEquals("ACME-1", json.getString("vulnId"));
        Assert.assertEquals("INTERNAL", json.getString("source"));
        Assert.assertEquals("Something is vulnerable", json.getString("description"));
        Assert.assertEquals(6.0, json.getJsonNumber("cvssV2BaseScore").doubleValue(), 0);
        Assert.assertEquals(6.4, json.getJsonNumber("cvssV2ImpactSubScore").doubleValue(), 0);
        Assert.assertEquals(6.8, json.getJsonNumber("cvssV2ExploitabilitySubScore").doubleValue(), 0);
        Assert.assertEquals("(AV:N/AC:M/Au:S/C:P/I:P/A:P)", json.getString("cvssV2Vector"));
        Assert.assertEquals(6.3, json.getJsonNumber("cvssV3BaseScore").doubleValue(), 0);
        Assert.assertEquals(3.4, json.getJsonNumber("cvssV3ImpactSubScore").doubleValue(), 0);
        Assert.assertEquals(2.8, json.getJsonNumber("cvssV3ExploitabilitySubScore").doubleValue(), 0);
        Assert.assertEquals(1.0, json.getJsonNumber("owaspRRLikelihoodScore").doubleValue(), 0);
        Assert.assertEquals(1.25, json.getJsonNumber("owaspRRTechnicalImpactScore").doubleValue(), 0);
        Assert.assertEquals(1.75, json.getJsonNumber("owaspRRBusinessImpactScore").doubleValue(), 0);
        Assert.assertEquals("CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L", json.getString("cvssV3Vector"));
        Assert.assertEquals("SL:1/M:1/O:0/S:2/ED:1/EE:1/A:1/ID:1/LC:2/LI:1/LAV:1/LAC:1/FD:1/RD:1/NC:2/PV:3", json.getString("owaspRRVector"));
        Assert.assertEquals("MEDIUM", json.getString("severity"));
        Assert.assertEquals(1, json.getJsonArray("cwes").size());
        Assert.assertEquals(80, json.getJsonArray("cwes").getJsonObject(0).getInt("cweId"));
        Assert.assertEquals(1, json.getJsonArray("tags").size());
        Assert.assertEquals("vuln-tag", json.getJsonArray("tags").getJsonObject(0).getString("name"));
        Assert.assertEquals("Improper Neutralization of Script-Related HTML Tags in a Web Page (Basic XSS)", json.getJsonArray("cwes").getJsonObject(0).getString("name"));
        Assert.assertTrue(UuidUtil.isValidUUID(json.getString("uuid")));
    }

    @Test
    public void updateVulnerabilityInvalidTest() {
        JsonObject payload = Json.createObjectBuilder()
                .add("vulnId", "ACME-1")
                .add("description", "Something is vulnerable")
                .add("cwes", Json.createArrayBuilder().add(Json.createObjectBuilder().add("cweId", 80)))
                .add("cvssV2Vector", "(AV:N/AC:M/Au:S/C:P/I:P/A:P)")
                .add("cvssV3Vector", "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L")
                .add("owaspRRVector", "SL:1/M:1/O:0/S:2/ED:1/EE:1/A:1/ID:1/LC:2/LI:1/LAV:1/LAC:1/FD:1/RD:1/NC:2/PV:3")
                .add("uuid", UUID.randomUUID().toString())
                .build();
        Response response = jersey.target(V1_VULNERABILITY).request()
                .header(X_API_KEY, apiKey)
                .post(Entity.json(payload.toString()));
        Assert.assertEquals(404, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The vulnerability could not be found.", body);
    }

    @Test
    public void updateVulnerabilityUnchangableTest() {
        Vulnerability vuln = new Vulnerability();
        vuln.setVulnId("ACME-1");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        qm.createVulnerability(vuln, false);
        JsonObject payload = Json.createObjectBuilder()
                .add("vulnId", "ACME-2")
                .add("description", "Something is vulnerable")
                .add("cwes", Json.createArrayBuilder().add(Json.createObjectBuilder().add("cweId", 80)))
                .add("cvssV2Vector", "(AV:N/AC:M/Au:S/C:P/I:P/A:P)")
                .add("cvssV3Vector", "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L")
                .add("owaspRRVector", "SL:1/M:1/O:0/S:2/ED:1/EE:1/A:1/ID:1/LC:2/LI:1/LAV:1/LAC:1/FD:1/RD:1/NC:2/PV:3")
                .add("uuid", vuln.getUuid().toString())
                .build();
        Response response = jersey.target(V1_VULNERABILITY).request()
                .header(X_API_KEY, apiKey)
                .post(Entity.json(payload.toString()));
        Assert.assertEquals(406, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The vulnId may not be changed.", body);
    }

    @Test
    public void deleteVulnerabilityTest() {
        final VulnerableSoftware vs = qm.persist(new VulnerableSoftware());
        var vuln = new Vulnerability();
        vuln.setVulnId("ACME-1");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        vuln.setVulnerableSoftware(List.of(vs));
        vuln = qm.createVulnerability(vuln, false);
        final AffectedVersionAttribution attribution = qm.persist(new AffectedVersionAttribution(Vulnerability.Source.INTERNAL, vuln, vs));

        final Response response = jersey.target(V1_VULNERABILITY + "/" + vuln.getUuid()).request()
                .header(X_API_KEY, apiKey)
                .delete();
        Assert.assertEquals(204, response.getStatus());
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));

        Assert.assertNull(qm.getObjectByUuid(AffectedVersionAttribution.class, attribution.getUuid()));
        Assert.assertNotNull(qm.getObjectByUuid(VulnerableSoftware.class, vs.getUuid()));
        Assert.assertNull(qm.getObjectByUuid(Vulnerability.class, vuln.getUuid()));
    }

    @Test
    public void assignVulnerabilityTest() {
        Vulnerability vuln = new Vulnerability();
        vuln.setVulnId("ACME-1");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        qm.createVulnerability(vuln, false);
        Project project = qm.createProject("Acme Example", null, null, null, null, null, null, false);
        Component comp = new Component();
        comp.setProject(project);
        comp.setName("Test Component");
        comp = qm.createComponent(comp, false);
        Response response = jersey.target(V1_VULNERABILITY + "/source/INTERNAL/vuln/ACME-1/component/" + comp.getUuid().toString()).request()
                .header(X_API_KEY, apiKey)
                .post(Entity.entity(null, MediaType.APPLICATION_JSON));
        Assert.assertEquals(200, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
    }

    @Test
    public void assignVulnerabilityInvalidVulnerabilityTest() {
        Project project = qm.createProject("Acme Example", null, null, null, null, null, null, false);
        Component comp = new Component();
        comp.setProject(project);
        comp.setName("Test Component");
        comp = qm.createComponent(comp, false);
        Response response = jersey.target(V1_VULNERABILITY + "/source/INTERNAL/vuln/BLAH/component/" + comp.getUuid().toString()).request()
                .header(X_API_KEY, apiKey)
                .post(Entity.entity(null, MediaType.APPLICATION_JSON));
        Assert.assertEquals(404, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The vulnerability could not be found.", body);
    }

    @Test
    public void assignVulnerabilityInvalidComponentTest() {
        Vulnerability vuln = new Vulnerability();
        vuln.setVulnId("ACME-1");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        qm.createVulnerability(vuln, false);
        Response response = jersey.target(V1_VULNERABILITY + "/source/INTERNAL/vuln/ACME-1/component/" + UUID.randomUUID().toString()).request()
                .header(X_API_KEY, apiKey)
                .post(Entity.entity(null, MediaType.APPLICATION_JSON));
        Assert.assertEquals(404, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The component could not be found.", body);
    }

    @Test
    public void assignVulnerabilityByUuidTest() {
        Vulnerability vuln = new Vulnerability();
        vuln.setVulnId("ACME-1");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        vuln = qm.createVulnerability(vuln, false);
        Project project = qm.createProject("Acme Example", null, null, null, null, null, null, false);
        Component comp = new Component();
        comp.setProject(project);
        comp.setName("Test Component");
        comp = qm.createComponent(comp, false);
        Response response = jersey.target(V1_VULNERABILITY + "/" + vuln.getUuid().toString() + "/component/" + comp.getUuid().toString()).request()
                .header(X_API_KEY, apiKey)
                .post(Entity.entity(null, MediaType.APPLICATION_JSON));
        Assert.assertEquals(200, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
    }

    @Test
    public void assignVulnerabilityByUuidInvalidVulnerabilityTest() {
        Project project = qm.createProject("Acme Example", null, null, null, null, null, null, false);
        Component comp = new Component();
        comp.setProject(project);
        comp.setName("Test Component");
        comp = qm.createComponent(comp, false);
        Response response = jersey.target(V1_VULNERABILITY + "/" + UUID.randomUUID().toString() + "/component/" + comp.getUuid().toString()).request()
                .header(X_API_KEY, apiKey)
                .post(Entity.entity(null, MediaType.APPLICATION_JSON));
        Assert.assertEquals(404, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The vulnerability could not be found.", body);
    }

    @Test
    public void assignVulnerabilityByUuidInvalidComponentTest() {
        Vulnerability vuln = new Vulnerability();
        vuln.setVulnId("ACME-1");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        vuln = qm.createVulnerability(vuln, false);
        Response response = jersey.target(V1_VULNERABILITY + "/" + vuln.getUuid().toString() + "/component/" + UUID.randomUUID().toString()).request()
                .header(X_API_KEY, apiKey)
                .post(Entity.entity(null, MediaType.APPLICATION_JSON));
        Assert.assertEquals(404, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The component could not be found.", body);
    }

    @Test
    public void assignVulnerabilityAclTest() {
        enablePortfolioAccessControl();

        final var project = new Project();
        project.setName("acme-app");
        qm.persist(project);

        final var component = new Component();
        component.setProject(project);
        component.setName("acme-lib");
        qm.persist(component);

        final var vuln = new Vulnerability();
        vuln.setVulnId("INT-001");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        qm.persist(vuln);

        final Supplier<Response> responseSupplier = () -> jersey
                .target(V1_VULNERABILITY + "/source/INTERNAL/vuln/INT-001/component/" + component.getUuid())
                .request()
                .header(X_API_KEY, apiKey)
                .post(Entity.json(""));

        Response response = responseSupplier.get();
        assertThat(response.getStatus()).isEqualTo(403);
        assertThatJson(getPlainTextBody(response)).isEqualTo(/* language=JSON */ """
                {
                  "status": 403,
                  "title": "Project access denied",
                  "detail": "Access to the requested project is forbidden"
                }
                """);

        project.addAccessTeam(super.team);

        response = responseSupplier.get();
        assertThat(response.getStatus()).isEqualTo(200);
    }

    @Test
    public void assignVulnerabilityByUuidAclTest() {
        enablePortfolioAccessControl();

        final var project = new Project();
        project.setName("acme-app");
        qm.persist(project);

        final var component = new Component();
        component.setProject(project);
        component.setName("acme-lib");
        qm.persist(component);

        final var vuln = new Vulnerability();
        vuln.setVulnId("INT-001");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        qm.persist(vuln);

        final Supplier<Response> responseSupplier = () -> jersey
                .target(V1_VULNERABILITY + "/" + vuln.getUuid() + "/component/" + component.getUuid())
                .request()
                .header(X_API_KEY, apiKey)
                .post(Entity.json(""));

        Response response = responseSupplier.get();
        assertThat(response.getStatus()).isEqualTo(403);
        assertThatJson(getPlainTextBody(response)).isEqualTo(/* language=JSON */ """
                {
                  "status": 403,
                  "title": "Project access denied",
                  "detail": "Access to the requested project is forbidden"
                }
                """);

        project.addAccessTeam(super.team);

        response = responseSupplier.get();
        assertThat(response.getStatus()).isEqualTo(200);
    }

    @Test
    public void unassignVulnerabilityTest() {
        Vulnerability vuln = new Vulnerability();
        vuln.setVulnId("ACME-1");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        qm.createVulnerability(vuln, false);
        Project project = qm.createProject("Acme Example", null, null, null, null, null, null, false);
        Component comp = new Component();
        comp.setProject(project);
        comp.setName("Test Component");
        comp = qm.createComponent(comp, false);
        Response response = jersey.target(V1_VULNERABILITY + "/source/INTERNAL/vuln/ACME-1/component/" + comp.getUuid().toString()).request()
                .header(X_API_KEY, apiKey)
                .delete();
        Assert.assertEquals(200, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
    }

    @Test
    public void unassignVulnerabilityInvalidVulnerabilityTest() {
        Project project = qm.createProject("Acme Example", null, null, null, null, null, null, false);
        Component comp = new Component();
        comp.setProject(project);
        comp.setName("Test Component");
        comp = qm.createComponent(comp, false);
        Response response = jersey.target(V1_VULNERABILITY + "/source/INTERNAL/vuln/BLAH/component/" + comp.getUuid().toString()).request()
                .header(X_API_KEY, apiKey)
                .delete();
        Assert.assertEquals(404, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The vulnerability could not be found.", body);
    }

    @Test
    public void unassignVulnerabilityInvalidComponentTest() {
        Vulnerability vuln = new Vulnerability();
        vuln.setVulnId("ACME-1");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        qm.createVulnerability(vuln, false);
        Response response = jersey.target(V1_VULNERABILITY + "/source/INTERNAL/vuln/ACME-1/component/" + UUID.randomUUID().toString()).request()
                .header(X_API_KEY, apiKey)
                .delete();
        Assert.assertEquals(404, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The component could not be found.", body);
    }

    @Test
    public void unassignVulnerabilityByUuidTest() {
        Vulnerability vuln = new Vulnerability();
        vuln.setVulnId("ACME-1");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        vuln = qm.createVulnerability(vuln, false);
        Project project = qm.createProject("Acme Example", null, null, null, null, null, null, false);
        Component comp = new Component();
        comp.setProject(project);
        comp.setName("Test Component");
        comp = qm.createComponent(comp, false);
        Response response = jersey.target(V1_VULNERABILITY + "/" + vuln.getUuid().toString() + "/component/" + comp.getUuid().toString()).request()
                .header(X_API_KEY, apiKey)
                .delete();
        Assert.assertEquals(200, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
    }

    @Test
    public void unassignVulnerabilityByUuidInvalidVulnerabilityTest() {
        Project project = qm.createProject("Acme Example", null, null, null, null, null, null, false);
        Component comp = new Component();
        comp.setProject(project);
        comp.setName("Test Component");
        comp = qm.createComponent(comp, false);
        Response response = jersey.target(V1_VULNERABILITY + "/" + UUID.randomUUID().toString() + "/component/" + comp.getUuid().toString()).request()
                .header(X_API_KEY, apiKey)
                .delete();
        Assert.assertEquals(404, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The vulnerability could not be found.", body);
    }

    @Test
    public void unassignVulnerabilityByUuidInvalidComponentTest() {
        Vulnerability vuln = new Vulnerability();
        vuln.setVulnId("ACME-1");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        vuln = qm.createVulnerability(vuln, false);
        Response response = jersey.target(V1_VULNERABILITY + "/" + vuln.getUuid().toString() + "/component/" + UUID.randomUUID().toString()).request()
                .header(X_API_KEY, apiKey)
                .delete();
        Assert.assertEquals(404, response.getStatus(), 0);
        Assert.assertNull(response.getHeaderString(TOTAL_COUNT_HEADER));
        String body = getPlainTextBody(response);
        Assert.assertEquals("The component could not be found.", body);
    }

    @Test
    public void unassignVulnerabilityAclTest() {
        enablePortfolioAccessControl();

        final var project = new Project();
        project.setName("acme-app");
        qm.persist(project);

        final var component = new Component();
        component.setProject(project);
        component.setName("acme-lib");
        qm.persist(component);

        final var vuln = new Vulnerability();
        vuln.setVulnId("INT-001");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        vuln.setComponents(List.of(component));
        qm.persist(vuln);

        final Supplier<Response> responseSupplier = () -> jersey
                .target(V1_VULNERABILITY + "/source/INTERNAL/vuln/INT-001/component/" + component.getUuid())
                .request()
                .header(X_API_KEY, apiKey)
                .delete();

        Response response = responseSupplier.get();
        assertThat(response.getStatus()).isEqualTo(403);
        assertThatJson(getPlainTextBody(response)).isEqualTo(/* language=JSON */ """
                {
                  "status": 403,
                  "title": "Project access denied",
                  "detail": "Access to the requested project is forbidden"
                }
                """);

        project.addAccessTeam(super.team);

        response = responseSupplier.get();
        assertThat(response.getStatus()).isEqualTo(200);
    }

    @Test
    public void unassignVulnerabilityByUuidAclTest() {
        enablePortfolioAccessControl();

        final var project = new Project();
        project.setName("acme-app");
        qm.persist(project);

        final var component = new Component();
        component.setProject(project);
        component.setName("acme-lib");
        qm.persist(component);

        final var vuln = new Vulnerability();
        vuln.setVulnId("INT-001");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        vuln.setComponents(List.of(component));
        qm.persist(vuln);

        final Supplier<Response> responseSupplier = () -> jersey
                .target(V1_VULNERABILITY + "/" + vuln.getUuid() + "/component/" + component.getUuid())
                .request()
                .header(X_API_KEY, apiKey)
                .delete();

        Response response = responseSupplier.get();
        assertThat(response.getStatus()).isEqualTo(403);
        assertThatJson(getPlainTextBody(response)).isEqualTo(/* language=JSON */ """
                {
                  "status": 403,
                  "title": "Project access denied",
                  "detail": "Access to the requested project is forbidden"
                }
                """);

        project.addAccessTeam(super.team);

        response = responseSupplier.get();
        assertThat(response.getStatus()).isEqualTo(200);
    }

    private class SampleData {
        final Project p1;
        final Project p2;
        final Component c1;
        final Component c2;
        final Component c3;
        final Vulnerability v1;
        final Vulnerability v2;
        final Vulnerability v3;
        final Vulnerability v4;
        final Vulnerability v5;
        final VulnerableSoftware vs1;

        SampleData() {
            p1 = qm.createProject("Project 1", null, null, null, null, null, null, false);
            p2 = qm.createProject("Project 2", null, null, null, null, null, null, false);

            c1 = new Component();
            c1.setProject(p1);
            c1.setName("Component 1");
            c1.setPurl("pkg:maven/com.example/component-1@1.0.0");
            c1.setMd5("2AAF520D1F19AECF246A0995D91E93A5");
            c1.setSha1("3D5A54669CF8D4ED55B7DF5751FA18C3F72F0CFB");
            c1.setSha256("47602D7DFE910AD941FEA52E85E6E3F1C175434B0E6E261C31C766FE4C078A25");

            c2 = new Component();
            c2.setProject(p1);
            c2.setName("Component 2");
            c2.setPurl("pkg:maven/com.example/component-2@2.0.0");
            c2.setMd5("5EABD62FA03D159A96C77E6EEB6C7027");
            c2.setSha1("108BCF94A1C0E0F915B935C97F6BB9E50FB7C246");
            c2.setSha256("418716B003FE0268B6521EF7ACBED13F5BA491D593896D5DEB2058C42D87002D");

            // Identical component to C2, but in a different project
            c3 = new Component();
            c3.setProject(p2);
            c3.setName("Component 2");
            c3.setPurl("pkg:maven/com.example/component-2@2.0.0");
            c3.setMd5("5EABD62FA03D159A96C77E6EEB6C7027");
            c3.setSha1("108BCF94A1C0E0F915B935C97F6BB9E50FB7C246");
            c3.setSha256("418716B003FE0268B6521EF7ACBED13F5BA491D593896D5DEB2058C42D87002D");

            qm.createComponent(c1, false);
            qm.createComponent(c2, false);
            qm.createComponent(c3, false);

            var tag = qm.createTag("internal_tag");

            v1 = new Vulnerability();
            v1.setVulnId("INT-1");
            v1.setSource(Vulnerability.Source.INTERNAL);
            v1.setSeverity(Severity.CRITICAL);
            v1.setDescription("Description 1");
            v1.setCwes(List.of(123));
            v1.setTags(Set.of(tag));

            vs1 = new VulnerableSoftware();
            qm.persist(vs1);
            qm.persist(new AffectedVersionAttribution(Vulnerability.Source.INTERNAL, v1, vs1));
            v1.setVulnerableSoftware(List.of(vs1));

            v2 = new Vulnerability();
            v2.setVulnId("INT-2");
            v2.setSource(Vulnerability.Source.INTERNAL);
            v2.setSeverity(Severity.HIGH);
            v2.setDescription("Description 2");
            v2.setCwes(List.of(321));

            v3 = new Vulnerability();
            v3.setVulnId("INT-3");
            v3.setSource(Vulnerability.Source.INTERNAL);
            v3.setSeverity(Severity.MEDIUM);
            v3.setDescription("Description 3");

            v4 = new Vulnerability();
            v4.setVulnId("INT-4");
            v4.setSource(Vulnerability.Source.INTERNAL);
            v4.setSeverity(Severity.LOW);
            v4.setDescription("Description 4");
            v4.setCwes(List.of(123, 321));

            v5 = new Vulnerability();
            v5.setVulnId("INT-5");
            v5.setSource(Vulnerability.Source.INTERNAL);
            v5.setSeverity(Severity.CRITICAL);
            v5.setDescription("Description 5");

            qm.createVulnerability(v1, false);
            qm.createVulnerability(v2, false);
            qm.createVulnerability(v3, false);
            qm.createVulnerability(v4, false);
            qm.createVulnerability(v5, false);
            qm.addVulnerability(v1, c1, AnalyzerIdentity.NONE);
            qm.addVulnerability(v2, c1, AnalyzerIdentity.NONE);
            qm.addVulnerability(v3, c1, AnalyzerIdentity.NONE);
            qm.addVulnerability(v4, c2, AnalyzerIdentity.NONE);
            qm.addVulnerability(v5, c2, AnalyzerIdentity.NONE);
            qm.addVulnerability(v4, c3, AnalyzerIdentity.NONE);
            qm.addVulnerability(v5, c3, AnalyzerIdentity.NONE);

            withJdbiHandle(handle -> handle.attach(AnalysisDao.class)
                    .makeAnalysis(p1.getId(), c1.getId(), v3.getId(), AnalysisState.FALSE_POSITIVE, AnalysisJustification.CODE_NOT_REACHABLE, AnalysisResponse.WILL_NOT_FIX, "Analysis details here", true));
            withJdbiHandle(handle -> handle.attach(AnalysisDao.class)
                    .makeAnalysis(p2.getId(), c3.getId(), v5.getId(), AnalysisState.NOT_AFFECTED, AnalysisJustification.CODE_NOT_REACHABLE, AnalysisResponse.WILL_NOT_FIX, "Analysis details here", true));
        }
    }

    @Test
    public void updateVulnerabilityTagsTest() {
        Vulnerability vuln = new Vulnerability();
        vuln.setVulnId("ACME-1");
        vuln.setSource(Vulnerability.Source.INTERNAL);
        Tag existingTag = qm.createTag("old-tag");
        vuln.setTags(Set.of(existingTag));
        vuln = qm.createVulnerability(vuln, false);

        Response response = jersey.target(V1_VULNERABILITY + "/" + vuln.getUuid().toString() + "/tags")
                .request()
                .header(X_API_KEY, apiKey)
                .post(Entity.json(List.of("new-tag-1", "new-tag-2")));

        Assert.assertEquals(200, response.getStatus(), 0);
        JsonObject json = parseJsonObject(response);
        Assert.assertNotNull(json);
        Assert.assertEquals("ACME-1", json.getString("vulnId"));
        Assert.assertEquals("INTERNAL", json.getString("source"));
        Assert.assertEquals(2, json.getJsonArray("tags").size());
        Assert.assertEquals("new-tag-1", json.getJsonArray("tags").getJsonObject(0).getString("name"));
        Assert.assertEquals("new-tag-2", json.getJsonArray("tags").getJsonObject(1).getString("name"));
        Assert.assertTrue(UuidUtil.isValidUUID(json.getString("uuid")));
    }

    @Test
    public void getVulnerabilitiesByTagTest() {
        Vulnerability vuln1 = new Vulnerability();
        vuln1.setVulnId("ACME-1");
        vuln1.setSource(Vulnerability.Source.INTERNAL);
        qm.persist(vuln1);
        Vulnerability vuln2 = new Vulnerability();
        vuln2.setVulnId("ACME-2");
        vuln2.setSource(Vulnerability.Source.INTERNAL);
        qm.persist(vuln2);
        Tag tag = qm.createTag("v-tag");
        qm.bind(vuln1, List.of(tag));
        qm.bind(vuln2, List.of(tag));

        Response response = jersey.target(V1_VULNERABILITY + "/tag/" + tag.getName()).request()
                .header(X_API_KEY, apiKey)
                .get();
        Assert.assertEquals(200, response.getStatus(), 0);
        JsonArray json = parseJsonArray(response);
        Assert.assertNotNull(json);
        Assert.assertEquals(json.size(), 2);
    }
}

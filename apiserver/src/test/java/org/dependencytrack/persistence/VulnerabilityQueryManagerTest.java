/*
 * This file is part of Dependency-Track.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 * Copyright (c) OWASP Foundation. All Rights Reserved.
 */
package org.dependencytrack.persistence;

import org.dependencytrack.PersistenceCapableTest;
import org.dependencytrack.model.Component;
import org.dependencytrack.model.Epss;
import org.dependencytrack.model.ExternalReference;
import org.dependencytrack.model.OrganizationalContact;
import org.dependencytrack.model.Project;
import org.dependencytrack.model.Severity;
import org.dependencytrack.model.Vulnerability;
import org.dependencytrack.model.VulnerabilityAlias;
import org.dependencytrack.persistence.jdbi.VulnerabilityAliasDao;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;

import java.math.BigDecimal;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.dependencytrack.persistence.jdbi.JdbiFactory.useJdbiTransaction;

public class VulnerabilityQueryManagerTest extends PersistenceCapableTest {

    @Nested
    public class VulnerabilityEpssTest {

        private Project project;
        private Component component;

        @BeforeEach
        public void setupData() {
            var vulnA = new Vulnerability();
            vulnA.setVulnId("INT-001");
            vulnA.setSource(Vulnerability.Source.INTERNAL);
            vulnA.setSeverity(Severity.HIGH);
            var vulnB = new Vulnerability();
            vulnB.setVulnId("INT-002");
            vulnB.setSource(Vulnerability.Source.INTERNAL);
            vulnB.setSeverity(Severity.HIGH);
            qm.persist(List.of(vulnA, vulnB));

            var epss = new Epss();
            epss.setCve(vulnA.getVulnId());
            epss.setScore(BigDecimal.valueOf(1.2));
            epss.setPercentile(BigDecimal.valueOf(3.4));
            qm.persist(epss);

            var aliasA = new VulnerabilityAlias();
            aliasA.setInternalId("INT-001");
            aliasA.setOsvId("GO-1000");
            var aliasB = new VulnerabilityAlias();
            aliasB.setInternalId("INT-001");
            aliasB.setSnykId("SNYK-1000");
            useJdbiTransaction(handle -> new VulnerabilityAliasDao(handle).syncAll(List.of(aliasA, aliasB)));

            project = qm.createProject("Epss Test", null, null, null, null, null, null, false);
            component = new Component();
            component.setProject(project);
            component.setName("ABC");
            component.setPurl("pkg:maven/org.acme/abc");
            var extRef = new ExternalReference();
            extRef.setType(org.cyclonedx.model.ExternalReference.Type.WEBSITE);
            extRef.setUrl("www.test.com");
            component.addExternalReference(extRef);
            var author = new OrganizationalContact();
            author.setName("author");
            component.setAuthors(List.of(author));

            component.setVulnerabilities(List.of(vulnA, vulnB));

            Component component2 = new Component();
            component2.setProject(project);
            component2.setName("ABCD");
            component2.setPurl("pkg:maven/org.acme/abcd");
            component2.setVulnerabilities(List.of(vulnA));

            qm.persist(component, component2);
        }

        @Test
        public void getVulnerabilityEpssTest() {
            var vulnPersisted = qm.getVulnerabilityByVulnId("INTERNAL", "INT-001", false);
            assertThat(vulnPersisted).isNotNull();
            assertThat(vulnPersisted.getEpssScore()).isEqualByComparingTo("1.2");
            assertThat(vulnPersisted.getEpssPercentile()).isEqualByComparingTo("3.4");
        }

        @Test
        public void getVulnerabilitiesTest() {
            var vulnerabilities = qm.getVulnerabilities().getList(Vulnerability.class);
            assertThat(vulnerabilities).isNotNull();
            assertThat(vulnerabilities).satisfiesExactly(
                    vuln -> {
                        assertThat(vuln.getVulnId()).isEqualTo("INT-001");
                        assertThat(vuln.getEpssScore()).isEqualByComparingTo("1.2");
                        assertThat(vuln.getEpssPercentile()).isEqualByComparingTo("3.4");
                    },
                    vuln -> {
                        assertThat(vuln.getVulnId()).isEqualTo("INT-002");
                        assertThat(vuln.getEpssScore()).isNull();
                        assertThat(vuln.getEpssPercentile()).isNull();
                    }
            );
        }

        @Test
        public void getVulnerabilitiesByProjectTest() {
            var vulnerabilities = qm.getVulnerabilities(project, false);
            assertThat(vulnerabilities).isNotNull();
            assertThat(vulnerabilities).satisfiesExactly(
                    vuln -> {
                        assertThat(vuln.getVulnId()).isEqualTo("INT-001");
                        assertThat(vuln.getEpssScore()).isEqualByComparingTo("1.2");
                        assertThat(vuln.getEpssPercentile()).isEqualByComparingTo("3.4");
                        assertThat(vuln.getComponents().size()).isEqualTo(2);
                    },
                    vuln -> {
                        assertThat(vuln.getVulnId()).isEqualTo("INT-002");
                        assertThat(vuln.getEpssScore()).isNull();
                        assertThat(vuln.getEpssPercentile()).isNull();
                        assertThat(vuln.getComponents().size()).isEqualTo(1);
                    }
            );
        }

        @Test
        public void getVulnerabilitiesByComponentTest() {
            var vulnerabilities = qm.getVulnerabilities(component).getList(Vulnerability.class);
            assertThat(vulnerabilities).isNotNull();
            assertThat(vulnerabilities).satisfiesExactly(
                    vuln -> {
                        assertThat(vuln.getVulnId()).isEqualTo("INT-001");
                        assertThat(vuln.getEpssScore()).isEqualByComparingTo("1.2");
                        assertThat(vuln.getEpssPercentile()).isEqualByComparingTo("3.4");
                        assertThat(vuln.getAliases()).hasSize(2);
                    },
                    vuln -> {
                        assertThat(vuln.getVulnId()).isEqualTo("INT-002");
                        assertThat(vuln.getEpssScore()).isNull();
                        assertThat(vuln.getEpssPercentile()).isNull();
                    }
            );
        }
    }

    @Nested
    public class VulnerabilityTagTest {

        @BeforeEach
        public void setupData() {
            var vulnA = new Vulnerability();
            vulnA.setVulnId("INT-001");
            vulnA.setSource(Vulnerability.Source.INTERNAL);
            vulnA.setSeverity(Severity.HIGH);

            var vulnB = new Vulnerability();
            vulnB.setVulnId("INT-002");
            vulnB.setSource(Vulnerability.Source.INTERNAL);
            vulnB.setSeverity(Severity.LOW);

            qm.persist(List.of(vulnA, vulnB));

            var tag1 = qm.createTag("vtag-1");
            var tag2 = qm.createTag("vtag-2");

            qm.bind(vulnA, List.of(tag1, tag2));
            qm.bind(vulnB, List.of(tag2));
        }

        @Test
        public void testBindTagsToVulnerability() {

            var tagsBound = qm.getVulnerabilityByVulnId(Vulnerability.Source.INTERNAL, "INT-001");
            assertThat(tagsBound.getTags()).isNotNull();
            assertThat(tagsBound.getTags()).satisfiesExactlyInAnyOrder(
                    tag -> assertThat(tag.getName()).isEqualTo("vtag-1"),
                    tag -> assertThat(tag.getName()).isEqualTo("vtag-2")
            );

            tagsBound = qm.getVulnerabilityByVulnId(Vulnerability.Source.INTERNAL, "INT-002");
            assertThat(tagsBound.getTags()).isNotNull();
            assertThat(tagsBound.getTags()).satisfiesExactlyInAnyOrder(
                    tag -> assertThat(tag.getName()).isEqualTo("vtag-2")
            );

            var tag1Bound = qm.getTagByName("vtag-1");
            assertThat(tag1Bound.getVulnerabilities().size()).isEqualTo(1);

            var tag2Bound = qm.getTagByName("vtag-2");
            assertThat(tag2Bound.getVulnerabilities().size()).isEqualTo(2);
        }

        @Test
        public void testGetVulnerabilitiesByTag() {
            // One vulnerability is tagged with "vtag-1"
            var taggedVulnerabilities = qm.getVulnerabilities(qm.getTagByName("vtag-1"));
            assertThat(taggedVulnerabilities).isNotNull();
            assertThat(taggedVulnerabilities.getTotal()).isEqualTo(1);

            // Two vulnerabilities are tagged with "vtag-2"
            taggedVulnerabilities = qm.getVulnerabilities(qm.getTagByName("vtag-2"));
            assertThat(taggedVulnerabilities).isNotNull();
            assertThat(taggedVulnerabilities.getTotal()).isEqualTo(2);
        }
    }
}
/*
 * This file is part of Dependency-Track.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 * Copyright (c) OWASP Foundation. All Rights Reserved.
 */
package org.dependencytrack.persistence.jdbi;

import org.dependencytrack.PersistenceCapableTest;
import org.dependencytrack.model.VulnIdAndSource;
import org.dependencytrack.model.VulnerabilityAlias;
import org.jdbi.v3.core.Handle;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Named;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.Arguments;
import org.junit.jupiter.params.provider.MethodSource;

import java.util.List;
import java.util.Set;
import java.util.UUID;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import static org.assertj.core.api.Assertions.assertThat;
import static org.dependencytrack.persistence.jdbi.JdbiFactory.openJdbiHandle;
import static org.dependencytrack.persistence.jdbi.VulnerabilityAliasDaoTest.VulnerabilityAliasBuilder.anAlias;

class VulnerabilityAliasDaoTest extends PersistenceCapableTest {

    private Handle jdbiHandle;

    @BeforeEach
    public void before() throws Exception {
        super.before();
        jdbiHandle = openJdbiHandle();
    }

    @AfterEach
    public void after() {
        if (jdbiHandle != null) {
            jdbiHandle.close();
        }
        super.after();
    }

    @ParameterizedTest(name = "{0}")
    @MethodSource("syncTestCases")
    void shouldSync(
            List<VulnerabilityAlias> reportedAliases,
            List<Set<VulnIdAndSource>> expectedGroups) {
        jdbiHandle.useTransaction(txHandle -> {
            final var txDao = new VulnerabilityAliasDao(txHandle);
            txDao.syncAll(reportedAliases);
        });

        assertThat(getAllAliasGroups()).containsExactlyInAnyOrderElementsOf(expectedGroups);
    }

    @Test
    void shouldMergeMultipleGroupsIntoOne() {
        jdbiHandle.useTransaction(
                txHandle -> new VulnerabilityAliasDao(txHandle).syncAll(List.of(
                        anAlias().withCveId("CVE-1").withGhsaId("GHSA-1").build(),
                        anAlias().withSnykId("SNYK-1").withOsvId("GO-1").build()
                )));

        assertThat(getAllAliasGroups()).hasSize(2);

        jdbiHandle.useTransaction(
                txHandle -> new VulnerabilityAliasDao(txHandle).sync(
                        anAlias().withCveId("CVE-1").withSnykId("SNYK-1").build()));

        assertThat(getAllAliasGroups()).singleElement().isEqualTo(
                Set.of(
                        pair("CVE-1", "NVD"),
                        pair("GHSA-1", "GITHUB"),
                        pair("SNYK-1", "SNYK"),
                        pair("GO-1", "OSV")));
    }

    private record AliasRow(UUID groupId, String source, String vulnId) {
    }

    private List<Set<VulnIdAndSource>> getAllAliasGroups() {
        return jdbiHandle
                .createQuery("""
                        SELECT "GROUP_ID", "SOURCE", "VULN_ID"
                          FROM "VULNERABILITY_ALIAS"
                         ORDER BY "GROUP_ID", "SOURCE", "VULN_ID"
                        """)
                .map((rs, ctx) -> new AliasRow(
                        rs.getObject("GROUP_ID", UUID.class),
                        rs.getString("SOURCE"),
                        rs.getString("VULN_ID")))
                .list()
                .stream()
                .collect(Collectors.groupingBy(AliasRow::groupId))
                .values().stream()
                .map(rows -> rows.stream()
                        .map(row -> pair(row.vulnId(), row.source()))
                        .collect(Collectors.<VulnIdAndSource>toUnmodifiableSet()))
                .toList();
    }

    private static VulnIdAndSource pair(String vulnId, String source) {
        return new VulnIdAndSource(vulnId, source);
    }

    private static Stream<Arguments> syncTestCases() {
        return Stream.of(
                Arguments.of(
                        Named.of("disjoint identifiers are not merged", List.of(
                                anAlias().withGhsaId("GHSA-1000").withSnykId("SNYK-2000").build(),
                                anAlias().withCveId("CVE-1000").withSnykId("SNYK-1000").build())),
                        List.of(
                                Set.of(pair("CVE-1000", "NVD"), pair("SNYK-1000", "SNYK")),
                                Set.of(pair("GHSA-1000", "GITHUB"), pair("SNYK-2000", "SNYK")))
                ),
                Arguments.of(
                        Named.of("shared identifier merges into same group", List.of(
                                anAlias().withCveId("CVE-1000").withOsvId("GO-1000").build(),
                                anAlias().withCveId("CVE-1000").withOsvId("GO-2000").build(),
                                anAlias().withCveId("CVE-1000").withOsvId("GO-2000").withSnykId("SNYK-1000").build())),
                        List.of(
                                Set.of(
                                        pair("CVE-1000", "NVD"),
                                        pair("GO-1000", "OSV"),
                                        pair("GO-2000", "OSV"),
                                        pair("SNYK-1000", "SNYK")))
                ),
                Arguments.of(
                        Named.of("disjoint identifiers are not merged (a)", List.of(
                                anAlias().withCveId("CVE-1000").withSnykId("SNYK-1000").build(),
                                anAlias().withGhsaId("GHSA-1000").withOsvId("GO-1000").build())),
                        List.of(
                                Set.of(pair("CVE-1000", "NVD"), pair("SNYK-1000", "SNYK")),
                                Set.of(pair("GHSA-1000", "GITHUB"), pair("GO-1000", "OSV")))
                ),
                Arguments.of(
                        Named.of("disjoint identifiers are not merged (b)", List.of(
                                anAlias().withGhsaId("GHSA-1000").withOsvId("GO-1000").build(),
                                anAlias().withCveId("CVE-1000").withSnykId("SNYK-1000").build())),
                        List.of(
                                Set.of(pair("CVE-1000", "NVD"), pair("SNYK-1000", "SNYK")),
                                Set.of(pair("GHSA-1000", "GITHUB"), pair("GO-1000", "OSV")))
                ),
                Arguments.of(
                        Named.of("one matching identifier merges (a)", List.of(
                                anAlias().withCveId("CVE-1000").withOsvId("GO-1000").build(),
                                anAlias().withCveId("CVE-1000").withSnykId("SNYK-1000").build())),
                        List.of(
                                Set.of(
                                        pair("CVE-1000", "NVD"),
                                        pair("GO-1000", "OSV"),
                                        pair("SNYK-1000", "SNYK")))
                ),
                Arguments.of(
                        Named.of("one matching identifier merges (b)", List.of(
                                anAlias().withCveId("CVE-1000").withSnykId("SNYK-1000").build(),
                                anAlias().withCveId("CVE-1000").withOsvId("GO-1000").build())),
                        List.of(
                                Set.of(
                                        pair("CVE-1000", "NVD"),
                                        pair("SNYK-1000", "SNYK"),
                                        pair("GO-1000", "OSV")))
                ),
                Arguments.of(
                        Named.of("one matching with multiple additional merges (a)", List.of(
                                anAlias().withCveId("CVE-1000").withSnykId("SNYK-1000").build(),
                                anAlias().withCveId("CVE-1000").withGhsaId("GHSA-1000").withOsvId("GO-1000").build())),
                        List.of(
                                Set.of(
                                        pair("CVE-1000", "NVD"),
                                        pair("SNYK-1000", "SNYK"),
                                        pair("GHSA-1000", "GITHUB"),
                                        pair("GO-1000", "OSV")))
                ),
                Arguments.of(
                        Named.of("one matching with multiple additional merges (b)", List.of(
                                anAlias().withCveId("CVE-1000").withGhsaId("GHSA-1000").withOsvId("GO-1000").build(),
                                anAlias().withCveId("CVE-1000").withSnykId("SNYK-1000").build())),
                        List.of(
                                Set.of(
                                        pair("CVE-1000", "NVD"),
                                        pair("GHSA-1000", "GITHUB"),
                                        pair("GO-1000", "OSV"),
                                        pair("SNYK-1000", "SNYK")))
                ),
                Arguments.of(
                        Named.of("two matching identifiers merge (a)", List.of(
                                anAlias().withCveId("CVE-1000").withGhsaId("GHSA-1000").withSnykId("SNYK-1000").build(),
                                anAlias().withCveId("CVE-1000").withGhsaId("GHSA-1000").withOsvId("GO-1000").build())),
                        List.of(
                                Set.of(
                                        pair("CVE-1000", "NVD"),
                                        pair("GHSA-1000", "GITHUB"),
                                        pair("SNYK-1000", "SNYK"),
                                        pair("GO-1000", "OSV")))
                ),
                Arguments.of(
                        Named.of("two matching identifiers merge (b)", List.of(
                                anAlias().withCveId("CVE-1000").withGhsaId("GHSA-1000").withOsvId("GO-1000").build(),
                                anAlias().withCveId("CVE-1000").withGhsaId("GHSA-1000").withSnykId("SNYK-1000").build())),
                        List.of(
                                Set.of(
                                        pair("CVE-1000", "NVD"),
                                        pair("GHSA-1000", "GITHUB"),
                                        pair("GO-1000", "OSV"),
                                        pair("SNYK-1000", "SNYK")))
                ),
                Arguments.of(
                        Named.of("multiple IDs per source are all preserved", List.of(
                                anAlias().withCveId("CVE-1000").withOsvId("GO-1000").build(),
                                anAlias().withCveId("CVE-1000").withOsvId("GO-2000").build())),
                        List.of(
                                Set.of(
                                        pair("CVE-1000", "NVD"),
                                        pair("GO-1000", "OSV"),
                                        pair("GO-2000", "OSV")))
                ),
                Arguments.of(
                        Named.of("identical identifiers do not create duplicates", List.of(
                                anAlias().withCveId("CVE-1000").withSnykId("SNYK-1000").build(),
                                anAlias().withCveId("CVE-1000").withSnykId("SNYK-1000").build())),
                        List.of(
                                Set.of(pair("CVE-1000", "NVD"), pair("SNYK-1000", "SNYK")))
                ),
                Arguments.of(
                        Named.of("GO-2022-0586", List.of(
                                anAlias().withCveId("CVE-2022-26945").withOsvId("GO-2022-0586").build(),
                                anAlias().withCveId("CVE-2022-30321").withOsvId("GO-2022-0586").build(),
                                anAlias().withCveId("CVE-2022-30322").withOsvId("GO-2022-0586").build(),
                                anAlias().withCveId("CVE-2022-30323").withOsvId("GO-2022-0586").build(),
                                anAlias().withGhsaId("GHSA-28r2-q6m8-9hpx").withOsvId("GO-2022-0586").build(),
                                anAlias().withGhsaId("GHSA-cjr4-fv6c-f3mv").withOsvId("GO-2022-0586").build(),
                                anAlias().withGhsaId("GHSA-fcgg-rvwg-jv58").withOsvId("GO-2022-0586").build(),
                                anAlias().withGhsaId("GHSA-x24g-9w7v-vprh").withOsvId("GO-2022-0586").build())),
                        List.of(
                                Set.of(
                                        pair("CVE-2022-26945", "NVD"),
                                        pair("CVE-2022-30321", "NVD"),
                                        pair("CVE-2022-30322", "NVD"),
                                        pair("CVE-2022-30323", "NVD"),
                                        pair("GHSA-28r2-q6m8-9hpx", "GITHUB"),
                                        pair("GHSA-cjr4-fv6c-f3mv", "GITHUB"),
                                        pair("GHSA-fcgg-rvwg-jv58", "GITHUB"),
                                        pair("GHSA-x24g-9w7v-vprh", "GITHUB"),
                                        pair("GO-2022-0586", "OSV")))
                ),
                Arguments.of(
                        Named.of("SNYK-JAVA-ORGECLIPSEJETTY-2945452/53", List.of(
                                anAlias().withCveId("CVE-1000").withSnykId("SNYK-1000").build(),
                                anAlias().withGhsaId("GHSA-1000").withSnykId("SNYK-1000").build(),
                                anAlias().withGhsaId("GHSA-1000").withSnykId("SNYK-2000").build(),
                                anAlias().withCveId("CVE-1000").withSnykId("SNYK-2000").build())),
                        List.of(
                                Set.of(
                                        pair("CVE-1000", "NVD"),
                                        pair("GHSA-1000", "GITHUB"),
                                        pair("SNYK-1000", "SNYK"),
                                        pair("SNYK-2000", "SNYK")))
                ),
                Arguments.of(
                        Named.of("SNYK-JAVA-COMFASTERXMLWOODSTOX-3091135", List.of(
                                anAlias().withGhsaId("GHSA-9fwf-46g9-45rx").withSnykId("SNYK-JAVA-COMFASTERXMLWOODSTOX-3091135").build(),
                                anAlias().withGhsaId("GHSA-3f7h-mf4q-vrm4").withSnykId("SNYK-JAVA-COMFASTERXMLWOODSTOX-3091135").build(),
                                anAlias().withGhsaId("GHSA-5hc5-c3m9-8vcj").withSnykId("SNYK-JAVA-COMFASTERXMLWOODSTOX-3091135").build(),
                                anAlias().withGhsaId("GHSA-fv22-xp26-mm9w").withSnykId("SNYK-JAVA-COMFASTERXMLWOODSTOX-3091135").build(),
                                anAlias().withGhsaId("GHSA-4rv7-wj6m-6c6r").withSnykId("SNYK-JAVA-COMFASTERXMLWOODSTOX-3091135").build(),
                                anAlias().withCveId("CVE-2022-40152").withSnykId("SNYK-JAVA-COMFASTERXMLWOODSTOX-3091135").build(),
                                anAlias().withCveId("CVE-2022-40152").withGhsaId("GHSA-3f7h-mf4q-vrm4").build(),
                                anAlias().withCveId("CVE-2022-40154").withGhsaId("GHSA-9fwf-46g9-45rx").build(),
                                anAlias().withCveId("CVE-2022-40156").withGhsaId("GHSA-4rv7-wj6m-6c6r").build(),
                                anAlias().withCveId("CVE-2022-40153").withGhsaId("GHSA-fv22-xp26-mm9w").build(),
                                anAlias().withCveId("CVE-2022-40155").withGhsaId("GHSA-5hc5-c3m9-8vcj").build())),
                        List.of(
                                Set.of(
                                        pair("CVE-2022-40152", "NVD"),
                                        pair("CVE-2022-40153", "NVD"),
                                        pair("CVE-2022-40154", "NVD"),
                                        pair("CVE-2022-40155", "NVD"),
                                        pair("CVE-2022-40156", "NVD"),
                                        pair("GHSA-9fwf-46g9-45rx", "GITHUB"),
                                        pair("GHSA-3f7h-mf4q-vrm4", "GITHUB"),
                                        pair("GHSA-5hc5-c3m9-8vcj", "GITHUB"),
                                        pair("GHSA-fv22-xp26-mm9w", "GITHUB"),
                                        pair("GHSA-4rv7-wj6m-6c6r", "GITHUB"),
                                        pair("SNYK-JAVA-COMFASTERXMLWOODSTOX-3091135", "SNYK")))
                ),
                Arguments.of(
                        Named.of("SNYK-JAVA-IONETTY-10822*", List.of(
                                anAlias().withCveId("CVE-2021-21290").withSnykId("SNYK-JAVA-IONETTY-1082234").build(),
                                anAlias().withGhsaId("GHSA-5mcr-gq6c-3hq2").withSnykId("SNYK-JAVA-IONETTY-1082234").build(),
                                anAlias().withCveId("CVE-2021-21290").withSnykId("SNYK-JAVA-IONETTY-1082235").build(),
                                anAlias().withGhsaId("GHSA-5mcr-gq6c-3hq2").withSnykId("SNYK-JAVA-IONETTY-1082235").build(),
                                anAlias().withCveId("CVE-2021-21290").withSnykId("SNYK-JAVA-IONETTY-1082236").build(),
                                anAlias().withGhsaId("GHSA-5mcr-gq6c-3hq2").withSnykId("SNYK-JAVA-IONETTY-1082236").build(),
                                anAlias().withCveId("CVE-2021-21290").withSnykId("SNYK-JAVA-IONETTY-1082238").build(),
                                anAlias().withGhsaId("GHSA-5mcr-gq6c-3hq2").withSnykId("SNYK-JAVA-IONETTY-1082238").build(),
                                anAlias().withCveId("CVE-2021-21290").withGhsaId("GHSA-5mcr-gq6c-3hq2").build())),
                        List.of(
                                Set.of(
                                        pair("CVE-2021-21290", "NVD"),
                                        pair("GHSA-5mcr-gq6c-3hq2", "GITHUB"),
                                        pair("SNYK-JAVA-IONETTY-1082234", "SNYK"),
                                        pair("SNYK-JAVA-IONETTY-1082235", "SNYK"),
                                        pair("SNYK-JAVA-IONETTY-1082236", "SNYK"),
                                        pair("SNYK-JAVA-IONETTY-1082238", "SNYK")))
                )
        );
    }

    static class VulnerabilityAliasBuilder {

        private final VulnerabilityAlias alias = new VulnerabilityAlias();

        static VulnerabilityAliasBuilder anAlias() {
            return new VulnerabilityAliasBuilder();
        }

        VulnerabilityAlias build() {
            return alias;
        }

        VulnerabilityAliasBuilder withCveId(String cveId) {
            this.alias.setCveId(cveId);
            return this;
        }

        VulnerabilityAliasBuilder withGhsaId(String ghsaId) {
            this.alias.setGhsaId(ghsaId);
            return this;
        }

        VulnerabilityAliasBuilder withOsvId(String osvId) {
            this.alias.setOsvId(osvId);
            return this;
        }

        VulnerabilityAliasBuilder withSnykId(String snykId) {
            this.alias.setSnykId(snykId);
            return this;
        }

        VulnerabilityAliasBuilder withInternalId(String internalId) {
            this.alias.setInternalId(internalId);
            return this;
        }

    }

}

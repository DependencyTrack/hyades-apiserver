/*
 * This file is part of Dependency-Track.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 * Copyright (c) OWASP Foundation. All Rights Reserved.
 */
package org.dependencytrack.tasks.vulnerabilitypolicy;

import io.minio.MinioClient;
import io.minio.errors.ErrorResponseException;
import io.minio.errors.InsufficientDataException;
import io.minio.errors.InternalException;
import io.minio.errors.InvalidResponseException;
import io.minio.errors.ServerException;
import io.minio.errors.XmlParserException;
import org.dependencytrack.tasks.vulnerabilitypolicy.blobstorage.MinioContainer;
import org.junit.After;
import org.junit.Before;
import org.junit.Rule;
import org.junit.Test;
import org.junit.contrib.java.lang.system.EnvironmentVariables;
import org.junit.jupiter.api.Assertions;

import java.io.IOException;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;

public class S3ClientTest {

    private static final String ACCESS_KEY = "MINIO_ACCESS_KEY";
    private static final String SECRET_KEY = "MINIO_SECRET_KEY";
    MinioContainer minioContainer;

    @Rule
    public EnvironmentVariables environmentVariables = new EnvironmentVariables();

    @Before
    public void beforeTest() {
        environmentVariables.set("VULNERABILITY_POLICY_ANALYSIS_ENABLED", "true");
        environmentVariables.set("VULNERABILITY_POLICY_BUNDLE_SOURCE_TYPE", "s3");
        minioContainer = new MinioContainer(
                new MinioContainer.CredentialsProvider(ACCESS_KEY, SECRET_KEY));
        minioContainer.start();

    }

    @After
    public void afterTest() {
        environmentVariables.clear("VULNERABILITY_POLICY_ANALYSIS_ENABLED",
                "VULNERABILITY_POLICY_BUNDLE_SOURCE_TYPE");
        minioContainer.stop();
    }

    @Test
    public void testS3Client() throws ServerException, InsufficientDataException, ErrorResponseException, IOException, NoSuchAlgorithmException, InvalidKeyException, InvalidResponseException, XmlParserException, InternalException {
        S3Client s3Client = new S3Client("http://" + minioContainer.getHostAddress(),
                "test.zip", "MINIO_ACCESS_KEY", "MINIO_SECRET_KEY", "testbucket", "nam");
        MinioClient client = s3Client.getMinioClient();
        String bundleToFetch = s3Client.getBundleToFetch();
        Assertions.assertEquals("testbucket", s3Client.getS3BucketName());
        Assertions.assertEquals(0, client.listBuckets().size());
        Assertions.assertEquals("test.zip", bundleToFetch);
    }
}

<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
        objectQuotingStrategy="QUOTE_ALL_OBJECTS"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="v5.6.0-roles" author="jhoward-lm">
        <createTable ifNotExists="true" tableName="ROLE">
            <column autoIncrement="true" name="ID" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ROLE_PK" />
            </column>

            <column name="NAME" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="ROLE_NAME_IDX"
                    validateNullable="true" validateUnique="true" />
            </column>

            <column name="UUID" type="UUID">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="ROLE_UUID_IDX"
                    validateNullable="true" validateUnique="true" />
            </column>
        </createTable>

        <createTable ifNotExists="true" tableName="ROLES_PERMISSIONS">
            <column name="ROLE_ID" type="BIGINT">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="ROLES_PERMISSIONS_COMPOSITE_IDX"
                    foreignKeyName="ROLES_PERMISSIONS_ROLE_FK"
                    referencedTableName="ROLE" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="true"
                    validateUnique="true" validateForeignKey="true" />
            </column>

            <column name="PERMISSION_ID" type="BIGINT">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="ROLES_PERMISSIONS_COMPOSITE_IDX"
                    foreignKeyName="ROLES_PERMISSIONS_PERMISSION_FK"
                    referencedTableName="PERMISSION" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="true"
                    validateUnique="true" validateForeignKey="true" />
            </column>
        </createTable>

        <createIndex indexName="ROLES_PERMISSIONS_ROLE_ID_IDX" tableName="ROLES_PERMISSIONS">
            <column name="ROLE_ID" />
        </createIndex>

        <createIndex indexName="ROLES_PERMISSIONS_PERMISSION_ID_IDX" tableName="ROLES_PERMISSIONS">
            <column name="PERMISSION_ID" />
        </createIndex>

        <createTable ifNotExists="true" tableName="USERS_PROJECTS_ROLES">
            <column name="USER_ID" type="BIGINT">
                <constraints nullable="false"
                    foreignKeyName="USERS_PROJECTS_ROLES_USER_FK"
                    referencedTableName="USER" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="true"
                    validateForeignKey="true" />
            </column>

            <column name="PROJECT_ID" type="BIGINT">
                <constraints nullable="false"
                    foreignKeyName="USERS_PROJECTS_ROLES_PROJECT_FK"
                    referencedTableName="PROJECT" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="true"
                    validateForeignKey="true" />
            </column>

            <column name="ROLE_ID" type="BIGINT">
                <constraints nullable="false"
                    foreignKeyName="USERS_PROJECTS_ROLES_ROLE_FK"
                    referencedTableName="ROLE" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="true"
                    validateForeignKey="true" />
            </column>
        </createTable>

        <createIndex unique="true" indexName="USERS_PROJECTS_ROLES_USER_PROJECT_IDX" tableName="USERS_PROJECTS_ROLES">
            <column name="USER_ID" />
            <column name="PROJECT_ID" />
        </createIndex>

        <createIndex indexName="USERS_PROJECTS_ROLES_ROLE_ID_IDX" tableName="USERS_PROJECTS_ROLES">
            <column name="ROLE_ID" />
        </createIndex>

        <sql splitStatements="false">
            -- Helper function to recalculate all user permissions for a project.
            -- Called by trigger functions to update the values in the USER_PROJECT_EFFECTIVE_PERMISSIONS table.
            CREATE OR REPLACE FUNCTION recalc_user_project_role_effective_permissions(project_ids BIGINT[])
            RETURNS void AS $$
            DECLARE
              tbl_prefix TEXT;
            BEGIN
              -- Remove any existing effective permissions for this project
              DELETE FROM "USER_PROJECT_EFFECTIVE_PERMISSIONS"
              WHERE "PROJECT_ID" = ANY(project_ids);

              -- Rebuild effective permissions for all users
              INSERT INTO "USER_PROJECT_EFFECTIVE_PERMISSIONS"
                ("USER_ID", "PROJECT_ID", "PERMISSION_ID", "PERMISSION_NAME")
              SELECT DISTINCT upr."USER_ID", upr."PROJECT_ID", rp."PERMISSION_ID", p."NAME"
                FROM "USERS_PROJECTS_ROLES" upr
               INNER JOIN "ROLES_PERMISSIONS" rp
                  ON rp."ROLE_ID" = upr."ROLE_ID"
               INNER JOIN "PERMISSION" p
                  ON p."ID" = rp."PERMISSION_ID"
               WHERE upr."PROJECT_ID" = ANY(project_ids);
            END;
            $$ LANGUAGE plpgsql;
        </sql>

        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION role_effective_permissions_mx_on_delete()
            RETURNS TRIGGER AS $$
            DECLARE
              project_ids BIGINT[];
              role_ids    BIGINT[];
            BEGIN
              SELECT ARRAY_AGG(DISTINCT "ROLE_ID")
                INTO role_ids
                FROM old_table;

              IF TG_TABLE_NAME = 'ROLES_PERMISSIONS' THEN
                SELECT ARRAY_AGG(sub."PROJECT_ID")
                  INTO project_ids
                  FROM (
                    SELECT upr."PROJECT_ID"
                      FROM "USERS_PROJECTS_ROLES" upr
                     INNER JOIN old_table
                        ON old_table."ROLE_ID" = upr."ROLE_ID"
                  ) sub;
              ELSE
                SELECT ARRAY_AGG(DISTINCT "PROJECT_ID")
                  INTO project_ids
                  FROM "USERS_PROJECTS_ROLES"
                 WHERE "ROLE_ID" = ANY(role_ids);
              END IF;

              PERFORM recalc_user_project_role_effective_permissions(project_ids);
              RETURN NULL;
            END;
            $$ LANGUAGE plpgsql;
        </sql>

        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION role_effective_permissions_mx_on_insert()
            RETURNS TRIGGER AS $$
            DECLARE
              project_ids BIGINT[];
              role_ids    BIGINT[];
            BEGIN
              SELECT ARRAY_AGG(DISTINCT "ROLE_ID")
                INTO role_ids
                FROM new_table;

              IF TG_TABLE_NAME = 'ROLES_PERMISSIONS' THEN
                SELECT ARRAY_AGG(sub."PROJECT_ID")
                  INTO project_ids
                  FROM (
                    SELECT upr."PROJECT_ID"
                      FROM "USERS_PROJECTS_ROLES" upr
                     INNER JOIN new_table
                        ON new_table."ROLE_ID" = upr."ROLE_ID"
                  ) sub;
              ELSE
                SELECT ARRAY_AGG(DISTINCT "PROJECT_ID")
                  INTO project_ids
                  FROM "USERS_PROJECTS_ROLES"
                 WHERE "ROLE_ID" = ANY(role_ids);
              END IF;

              PERFORM recalc_user_project_role_effective_permissions(project_ids);
              RETURN NULL;
            END;
            $$ LANGUAGE plpgsql;
        </sql>

        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION role_effective_permissions_mx_on_update()
            RETURNS TRIGGER AS $$
            DECLARE
              project_ids BIGINT[];
              role_ids    BIGINT[];
            BEGIN
              SELECT ARRAY_AGG("ROLE_ID")
                INTO role_ids
                FROM (
                  SELECT "ROLE_ID" FROM old_table
                   UNION
                  SELECT "ROLE_ID" FROM new_table
                ) roles;

              IF TG_TABLE_NAME = 'ROLES_PERMISSIONS' THEN
                SELECT ARRAY_AGG(sub."PROJECT_ID")
                  INTO project_ids
                  FROM (
                    SELECT upr."PROJECT_ID"
                      FROM "USERS_PROJECTS_ROLES" upr
                     INNER JOIN new_table
                        ON new_table."ROLE_ID" = upr."ROLE_ID"
                      FULL OUTER JOIN old_table
                        ON new_table."ROLE_ID" = old_table."ROLE_ID"
                  ) sub;
              ELSE
                SELECT ARRAY_AGG(DISTINCT "PROJECT_ID")
                  INTO project_ids
                  FROM "USERS_PROJECTS_ROLES"
                 WHERE "ROLE_ID" = ANY(role_ids);
              END IF;

              PERFORM recalc_user_project_role_effective_permissions(project_ids);
              RETURN NULL;
            END;
            $$ LANGUAGE plpgsql;
        </sql>

        <sql splitStatements="true">
            -- INSERT trigger for USERS_PROJECTS_ROLES
            CREATE TRIGGER trigger_effective_permissions_mx_on_users_roles_insert
            AFTER INSERT ON "USERS_PROJECTS_ROLES"
            REFERENCING NEW TABLE AS new_table
            FOR EACH STATEMENT
            EXECUTE FUNCTION role_effective_permissions_mx_on_insert();

            -- DELETE trigger for USERS_PROJECTS_ROLES
            CREATE TRIGGER trigger_effective_permissions_mx_on_users_roles_delete
            AFTER DELETE ON "USERS_PROJECTS_ROLES"
            REFERENCING OLD TABLE AS old_table
            FOR EACH STATEMENT
            EXECUTE FUNCTION role_effective_permissions_mx_on_delete();

            -- UPDATE trigger for USERS_PROJECTS_ROLES
            CREATE TRIGGER trigger_effective_permissions_mx_on_users_roles_update
            AFTER UPDATE ON "USERS_PROJECTS_ROLES"
            REFERENCING OLD TABLE AS old_table NEW TABLE AS new_table
            FOR EACH STATEMENT
            EXECUTE FUNCTION role_effective_permissions_mx_on_update();

            -- INSERT trigger for ROLES_PERMISSIONS
            CREATE TRIGGER trigger_effective_permissions_mx_on_roles_permissions_insert
            AFTER INSERT ON "ROLES_PERMISSIONS"
            REFERENCING NEW TABLE AS new_table
            FOR EACH STATEMENT
            EXECUTE FUNCTION role_effective_permissions_mx_on_insert();

            -- DELETE trigger for ROLES_PERMISSIONS
            CREATE TRIGGER trigger_effective_permissions_mx_on_roles_permissions_delete
            AFTER DELETE ON "ROLES_PERMISSIONS"
            REFERENCING OLD TABLE AS old_table
            FOR EACH STATEMENT
            EXECUTE FUNCTION role_effective_permissions_mx_on_delete();

            -- UPDATE trigger for ROLES_PERMISSIONS
            CREATE TRIGGER trigger_effective_permissions_mx_on_roles_permissions_update
            AFTER UPDATE ON "ROLES_PERMISSIONS"
            REFERENCING OLD TABLE AS old_table NEW TABLE AS new_table
            FOR EACH STATEMENT
            EXECUTE FUNCTION effective_permissions_mx_on_update();
        </sql>
    </changeSet>
</databaseChangeLog>

/*
 * This file is part of Dependency-Track.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 * Copyright (c) OWASP Foundation. All Rights Reserved.
 */
package org.dependencytrack.vulnanalysis;

import org.dependencytrack.model.VulnIdAndSource;
import org.dependencytrack.model.Vulnerability;
import org.jdbi.v3.core.Handle;
import org.jdbi.v3.core.statement.Query;

import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.function.BiPredicate;
import java.util.stream.Collectors;

/**
 * @since 5.7.0
 */
final class VulnerabilityDao {

    private final Handle handle;

    VulnerabilityDao(Handle handle) {
        this.handle = handle;
    }

    Map<VulnIdAndSource, Long> syncMany(
            Map<VulnIdAndSource, ConvertedVulnerability> convertedVulnByVulnIdAndSource,
            BiPredicate<Vulnerability.Source, String> canUpdatePredicate) {
        final var results = new HashMap<VulnIdAndSource, Long>(convertedVulnByVulnIdAndSource.size());

        for (final var entry : convertedVulnByVulnIdAndSource.entrySet()) {
            if (entry.getValue().internalVulnId() != null) {
                results.put(entry.getKey(), entry.getValue().internalVulnId());
            }
        }
        if (results.size() == convertedVulnByVulnIdAndSource.size()) {
            return results;
        }

        final int vulnsToSyncCount = convertedVulnByVulnIdAndSource.size() - results.size();
        final var vulnIds = new String[vulnsToSyncCount];
        final var sources = new String[vulnsToSyncCount];
        final var friendlyVulnIds = new String[vulnsToSyncCount];
        final var titles = new String[vulnsToSyncCount];
        final var subTitles = new String[vulnsToSyncCount];
        final var descriptions = new String[vulnsToSyncCount];
        final var details = new String[vulnsToSyncCount];
        final var recommendations = new String[vulnsToSyncCount];
        final var references = new String[vulnsToSyncCount];
        final var credits = new String[vulnsToSyncCount];
        final var createdArray = new Date[vulnsToSyncCount];
        final var publishedArray = new Date[vulnsToSyncCount];
        final var updatedArray = new Date[vulnsToSyncCount];
        final var cwesArray = new String[vulnsToSyncCount];
        final var cvssV2BaseScores = new Double[vulnsToSyncCount];
        final var cvssV2ImpactSubScores = new Double[vulnsToSyncCount];
        final var cvssV2ExploitabilitySubScores = new Double[vulnsToSyncCount];
        final var cvssV2Vectors = new String[vulnsToSyncCount];
        final var cvssV3BaseScores = new Double[vulnsToSyncCount];
        final var cvssV3ImpactSubScores = new Double[vulnsToSyncCount];
        final var cvssV3ExploitabilitySubScores = new Double[vulnsToSyncCount];
        final var cvssV3Vectors = new String[vulnsToSyncCount];
        final var owaspRRLikelihoodScores = new Double[vulnsToSyncCount];
        final var owaspRRTechnicalImpactScores = new Double[vulnsToSyncCount];
        final var owaspRRBusinessImpactScores = new Double[vulnsToSyncCount];
        final var owaspRRVectors = new String[vulnsToSyncCount];
        final var severities = new String[vulnsToSyncCount];
        final var vulnerableVersions = new String[vulnsToSyncCount];
        final var patchedVersions = new String[vulnsToSyncCount];
        final var canUpdateArray = new boolean[vulnsToSyncCount];

        // Determining whether a vulnerability is updatable requires
        // checking for which vulnerability sources mirroring is enabled.
        // To prevent excessive checks that all come to the same conclusion,
        // maintain a local cache of check results.
        final var canUpdateCache = new HashMap<Map.Entry<Vulnerability.Source, String>, Boolean>();

        int i = 0;
        for (final var entry : convertedVulnByVulnIdAndSource.entrySet()) {
            if (entry.getValue().internalVulnId() != null) {
                continue;
            }

            final Vulnerability vuln = entry.getValue().vuln();
            vulnIds[i] = vuln.getVulnId();
            sources[i] = vuln.getSource();
            friendlyVulnIds[i] = vuln.getFriendlyVulnId();
            titles[i] = vuln.getTitle();
            subTitles[i] = vuln.getSubTitle();
            descriptions[i] = vuln.getDescription();
            details[i] = vuln.getDetail();
            recommendations[i] = vuln.getRecommendation();
            references[i] = vuln.getReferences();
            credits[i] = vuln.getCredits();
            createdArray[i] = vuln.getCreated();
            publishedArray[i] = vuln.getPublished();
            updatedArray[i] = vuln.getUpdated();
            cwesArray[i] = (vuln.getCwes() != null && !vuln.getCwes().isEmpty())
                    ? vuln.getCwes().stream().map(String::valueOf).collect(Collectors.joining(","))
                    : null;
            cvssV2BaseScores[i] = vuln.getCvssV2BaseScore() != null
                    ? vuln.getCvssV2BaseScore().doubleValue()
                    : null;
            cvssV2ImpactSubScores[i] = vuln.getCvssV2ImpactSubScore() != null
                    ? vuln.getCvssV2ImpactSubScore().doubleValue()
                    : null;
            cvssV2ExploitabilitySubScores[i] = vuln.getCvssV2ExploitabilitySubScore() != null
                    ? vuln.getCvssV2ExploitabilitySubScore().doubleValue()
                    : null;
            cvssV2Vectors[i] = vuln.getCvssV2Vector();
            cvssV3BaseScores[i] = vuln.getCvssV3BaseScore() != null
                    ? vuln.getCvssV3BaseScore().doubleValue()
                    : null;
            cvssV3ImpactSubScores[i] = vuln.getCvssV3ImpactSubScore() != null
                    ? vuln.getCvssV3ImpactSubScore().doubleValue()
                    : null;
            cvssV3ExploitabilitySubScores[i] = vuln.getCvssV3ExploitabilitySubScore() != null
                    ? vuln.getCvssV3ExploitabilitySubScore().doubleValue()
                    : null;
            cvssV3Vectors[i] = vuln.getCvssV3Vector();
            owaspRRLikelihoodScores[i] = vuln.getOwaspRRLikelihoodScore() != null
                    ? vuln.getOwaspRRLikelihoodScore().doubleValue()
                    : null;
            owaspRRTechnicalImpactScores[i] = vuln.getOwaspRRTechnicalImpactScore() != null
                    ? vuln.getOwaspRRTechnicalImpactScore().doubleValue()
                    : null;
            owaspRRBusinessImpactScores[i] = vuln.getOwaspRRBusinessImpactScore() != null
                    ? vuln.getOwaspRRBusinessImpactScore().doubleValue()
                    : null;
            owaspRRVectors[i] = vuln.getOwaspRRVector();
            severities[i] = vuln.getSeverity() != null
                    ? vuln.getSeverity().name()
                    : null;
            vulnerableVersions[i] = vuln.getVulnerableVersions();
            patchedVersions[i] = vuln.getPatchedVersions();
            canUpdateArray[i] = canUpdateCache.computeIfAbsent(
                    Map.entry(
                            Vulnerability.Source.valueOf(vuln.getSource()),
                            entry.getValue().analyzerName()),
                    k -> canUpdatePredicate.test(k.getKey(), k.getValue()));
            i++;
        }

        final Query query = handle.createQuery("""
                WITH
                cte_input AS (
                  SELECT vuln_id
                       , source
                       , friendly_vuln_id
                       , title
                       , sub_title
                       , description
                       , detail
                       , recommendation
                       , "references"
                       , credits
                       , created
                       , published
                       , updated
                       , cwes
                       , cvss_v2_base_score
                       , cvss_v2_impact_sub_score
                       , cvss_v2_exploitability_sub_score
                       , cvss_v2_vector
                       , cvss_v3_base_score
                       , cvss_v3_impact_sub_score
                       , cvss_v3_exploitability_sub_score
                       , cvss_v3_vector
                       , owasp_rr_likelihood_score
                       , owasp_rr_technical_impact_score
                       , owasp_rr_business_impact_score
                       , owasp_rr_vector
                       , "severity"
                       , vulnerable_versions
                       , patched_versions
                       , can_update
                    FROM UNNEST (
                      :vulnIds
                    , :sources
                    , :friendlyVulnIds
                    , :titles
                    , :subTitles
                    , :descriptions
                    , :details
                    , :recommendations
                    , :references
                    , :credits
                    , :createdArray
                    , :publishedArray
                    , :updatedArray
                    , :cwesArray
                    , :cvssV2BaseScores
                    , :cvssV2ImpactSubScores
                    , :cvssV2ExploitabilitySubScores
                    , :cvssV2Vectors
                    , :cvssV3BaseScores
                    , :cvssV3ImpactSubScores
                    , :cvssV3ExploitabilitySubScores
                    , :cvssV3Vectors
                    , :owaspRRLikelihoodScores
                    , :owaspRRTechnicalImpactScores
                    , :owaspRRBusinessImpactScores
                    , :owaspRRVectors
                    , :severities
                    , :vulnerableVersions
                    , :patchedVersions
                    , :canUpdateArray
                    ) AS t (
                      vuln_id
                    , source
                    , friendly_vuln_id
                    , title
                    , sub_title
                    , description
                    , detail
                    , recommendation
                    , "references"
                    , credits
                    , created
                    , published
                    , updated
                    , cwes
                    , cvss_v2_base_score
                    , cvss_v2_impact_sub_score
                    , cvss_v2_exploitability_sub_score
                    , cvss_v2_vector
                    , cvss_v3_base_score
                    , cvss_v3_impact_sub_score
                    , cvss_v3_exploitability_sub_score
                    , cvss_v3_vector
                    , owasp_rr_likelihood_score
                    , owasp_rr_technical_impact_score
                    , owasp_rr_business_impact_score
                    , owasp_rr_vector
                    , "severity"
                    , vulnerable_versions
                    , patched_versions
                    , can_update
                    )
                ),
                cte_modified AS (
                  INSERT INTO "VULNERABILITY" AS v (
                    "VULNID"
                  , "SOURCE"
                  , "FRIENDLYVULNID"
                  , "TITLE"
                  , "SUBTITLE"
                  , "DESCRIPTION"
                  , "DETAIL"
                  , "RECOMMENDATION"
                  , "REFERENCES"
                  , "CREDITS"
                  , "CREATED"
                  , "PUBLISHED"
                  , "UPDATED"
                  , "CWES"
                  , "CVSSV2BASESCORE"
                  , "CVSSV2IMPACTSCORE"
                  , "CVSSV2EXPLOITSCORE"
                  , "CVSSV2VECTOR"
                  , "CVSSV3BASESCORE"
                  , "CVSSV3IMPACTSCORE"
                  , "CVSSV3EXPLOITSCORE"
                  , "CVSSV3VECTOR"
                  , "OWASPRRLIKELIHOODSCORE"
                  , "OWASPRRTECHNICALIMPACTSCORE"
                  , "OWASPRRBUSINESSIMPACTSCORE"
                  , "OWASPRRVECTOR"
                  , "SEVERITY"
                  , "VULNERABLEVERSIONS"
                  , "PATCHEDVERSIONS"
                  , "UUID"
                  )
                  SELECT vuln_id
                       , source
                       , friendly_vuln_id
                       , title
                       , sub_title
                       , description
                       , detail
                       , recommendation
                       , "references"
                       , credits
                       , created
                       , published
                       , updated
                       , cwes
                       , cvss_v2_base_score
                       , cvss_v2_impact_sub_score
                       , cvss_v2_exploitability_sub_score
                       , cvss_v2_vector
                       , cvss_v3_base_score
                       , cvss_v3_impact_sub_score
                       , cvss_v3_exploitability_sub_score
                       , cvss_v3_vector
                       , owasp_rr_likelihood_score
                       , owasp_rr_technical_impact_score
                       , owasp_rr_business_impact_score
                       , owasp_rr_vector
                       , CAST("severity" AS severity)
                       , vulnerable_versions
                       , patched_versions
                       , GEN_RANDOM_UUID()
                    FROM cte_input
                   ORDER BY vuln_id
                          , source
                  ON CONFLICT ("VULNID", "SOURCE") DO UPDATE
                  SET "FRIENDLYVULNID" = EXCLUDED."FRIENDLYVULNID"
                    , "TITLE" = EXCLUDED."TITLE"
                    , "SUBTITLE" = EXCLUDED."SUBTITLE"
                    , "DESCRIPTION" = EXCLUDED."DESCRIPTION"
                    , "DETAIL" = EXCLUDED."DETAIL"
                    , "RECOMMENDATION" = EXCLUDED."RECOMMENDATION"
                    , "REFERENCES" = EXCLUDED."REFERENCES"
                    , "CREDITS" = EXCLUDED."CREDITS"
                    , "CREATED" = EXCLUDED."CREATED"
                    , "PUBLISHED" = EXCLUDED."PUBLISHED"
                    , "UPDATED" = EXCLUDED."UPDATED"
                    , "CWES" = EXCLUDED."CWES"
                    , "CVSSV2BASESCORE" = EXCLUDED."CVSSV2BASESCORE"
                    , "CVSSV2IMPACTSCORE" = EXCLUDED."CVSSV2IMPACTSCORE"
                    , "CVSSV2EXPLOITSCORE" = EXCLUDED."CVSSV2EXPLOITSCORE"
                    , "CVSSV2VECTOR" = EXCLUDED."CVSSV2VECTOR"
                    , "CVSSV3BASESCORE" = EXCLUDED."CVSSV3BASESCORE"
                    , "CVSSV3IMPACTSCORE" = EXCLUDED."CVSSV3IMPACTSCORE"
                    , "CVSSV3EXPLOITSCORE" = EXCLUDED."CVSSV3EXPLOITSCORE"
                    , "CVSSV3VECTOR" = EXCLUDED."CVSSV3VECTOR"
                    , "OWASPRRLIKELIHOODSCORE" = EXCLUDED."OWASPRRLIKELIHOODSCORE"
                    , "OWASPRRTECHNICALIMPACTSCORE" = EXCLUDED."OWASPRRTECHNICALIMPACTSCORE"
                    , "OWASPRRBUSINESSIMPACTSCORE" = EXCLUDED."OWASPRRBUSINESSIMPACTSCORE"
                    , "OWASPRRVECTOR" = EXCLUDED."OWASPRRVECTOR"
                    , "SEVERITY" = EXCLUDED."SEVERITY"
                    , "VULNERABLEVERSIONS" = EXCLUDED."VULNERABLEVERSIONS"
                    , "PATCHEDVERSIONS" = EXCLUDED."PATCHEDVERSIONS"
                  WHERE TRUE
                    -- Only update when allowed to.
                    AND EXISTS (
                          SELECT 1
                            FROM cte_input AS i
                           WHERE i.vuln_id = v."VULNID"
                             AND i.source = v."SOURCE"
                             AND i.can_update
                        )
                    -- Only update when the incoming data is not older than the existing data.
                    AND (v."UPDATED" IS NULL OR EXCLUDED."UPDATED" > v."UPDATED")
                    -- Only update when any relevant field changed.
                    AND (
                          v."FRIENDLYVULNID"
                        , v."TITLE"
                        , v."SUBTITLE"
                        , v."DESCRIPTION"
                        , v."DETAIL"
                        , v."RECOMMENDATION"
                        , v."REFERENCES"
                        , v."CREDITS"
                        , v."CREATED"
                        , v."PUBLISHED"
                        , v."UPDATED"
                        , v."CWES"
                        , v."CVSSV2BASESCORE"
                        , v."CVSSV2IMPACTSCORE"
                        , v."CVSSV2EXPLOITSCORE"
                        , v."CVSSV2VECTOR"
                        , v."CVSSV3BASESCORE"
                        , v."CVSSV3IMPACTSCORE"
                        , v."CVSSV3EXPLOITSCORE"
                        , v."CVSSV3VECTOR"
                        , v."OWASPRRLIKELIHOODSCORE"
                        , v."OWASPRRTECHNICALIMPACTSCORE"
                        , v."OWASPRRBUSINESSIMPACTSCORE"
                        , v."OWASPRRVECTOR"
                        , v."SEVERITY"
                        , v."VULNERABLEVERSIONS"
                        , v."PATCHEDVERSIONS"
                        ) IS DISTINCT FROM (
                          EXCLUDED."FRIENDLYVULNID"
                        , EXCLUDED."TITLE"
                        , EXCLUDED."SUBTITLE"
                        , EXCLUDED."DESCRIPTION"
                        , EXCLUDED."DETAIL"
                        , EXCLUDED."RECOMMENDATION"
                        , EXCLUDED."REFERENCES"
                        , EXCLUDED."CREDITS"
                        , EXCLUDED."CREATED"
                        , EXCLUDED."PUBLISHED"
                        , EXCLUDED."UPDATED"
                        , EXCLUDED."CWES"
                        , EXCLUDED."CVSSV2BASESCORE"
                        , EXCLUDED."CVSSV2IMPACTSCORE"
                        , EXCLUDED."CVSSV2EXPLOITSCORE"
                        , EXCLUDED."CVSSV2VECTOR"
                        , EXCLUDED."CVSSV3BASESCORE"
                        , EXCLUDED."CVSSV3IMPACTSCORE"
                        , EXCLUDED."CVSSV3EXPLOITSCORE"
                        , EXCLUDED."CVSSV3VECTOR"
                        , EXCLUDED."OWASPRRLIKELIHOODSCORE"
                        , EXCLUDED."OWASPRRTECHNICALIMPACTSCORE"
                        , EXCLUDED."OWASPRRBUSINESSIMPACTSCORE"
                        , EXCLUDED."OWASPRRVECTOR"
                        , EXCLUDED."SEVERITY"
                        , EXCLUDED."VULNERABLEVERSIONS"
                        , EXCLUDED."PATCHEDVERSIONS"
                        )
                  RETURNING "VULNID"
                          , "SOURCE"
                          , "ID"
                )
                SELECT "VULNID"
                     , "SOURCE"
                     , "ID"
                  FROM cte_modified
                 UNION ALL
                SELECT v."VULNID"
                     , v."SOURCE"
                     , v."ID"
                  FROM "VULNERABILITY" AS v
                 INNER JOIN cte_input AS i
                    ON i.vuln_id = v."VULNID"
                   AND i.source = v."SOURCE"
                 WHERE NOT EXISTS (
                             SELECT 1
                               FROM cte_modified AS m
                              WHERE m."VULNID" = i.vuln_id
                                AND m."SOURCE" = i.source
                           )
                """);

        query
                .bind("vulnIds", vulnIds)
                .bind("sources", sources)
                .bind("friendlyVulnIds", friendlyVulnIds)
                .bind("titles", titles)
                .bind("subTitles", subTitles)
                .bind("descriptions", descriptions)
                .bind("details", details)
                .bind("recommendations", recommendations)
                .bind("references", references)
                .bind("credits", credits)
                .bind("createdArray", createdArray)
                .bind("publishedArray", publishedArray)
                .bind("updatedArray", updatedArray)
                .bind("cwesArray", cwesArray)
                .bind("cvssV2BaseScores", cvssV2BaseScores)
                .bind("cvssV2ImpactSubScores", cvssV2ImpactSubScores)
                .bind("cvssV2ExploitabilitySubScores", cvssV2ExploitabilitySubScores)
                .bind("cvssV2Vectors", cvssV2Vectors)
                .bind("cvssV3BaseScores", cvssV3BaseScores)
                .bind("cvssV3ImpactSubScores", cvssV3ImpactSubScores)
                .bind("cvssV3ExploitabilitySubScores", cvssV3ExploitabilitySubScores)
                .bind("cvssV3Vectors", cvssV3Vectors)
                .bind("owaspRRLikelihoodScores", owaspRRLikelihoodScores)
                .bind("owaspRRTechnicalImpactScores", owaspRRTechnicalImpactScores)
                .bind("owaspRRBusinessImpactScores", owaspRRBusinessImpactScores)
                .bind("owaspRRVectors", owaspRRVectors)
                .bind("severities", severities)
                .bind("vulnerableVersions", vulnerableVersions)
                .bind("patchedVersions", patchedVersions)
                .bind("canUpdateArray", canUpdateArray)
                .map((rs, ctx) -> Map.entry(
                        new VulnIdAndSource(rs.getString("VULNID"), rs.getString("SOURCE")),
                        rs.getLong("ID")))
                .stream()
                .forEach(entry -> results.put(entry.getKey(), entry.getValue()));

        return results;
    }

}

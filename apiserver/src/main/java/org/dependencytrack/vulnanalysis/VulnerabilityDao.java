/*
 * This file is part of Dependency-Track.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 * Copyright (c) OWASP Foundation. All Rights Reserved.
 */
package org.dependencytrack.vulnanalysis;

import org.dependencytrack.model.Vulnerability;
import org.dependencytrack.model.VulnerabilityKey;
import org.jdbi.v3.core.Handle;

import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Predicate;
import java.util.stream.Collectors;

/**
 * @since 5.7.0
 */
final class VulnerabilityDao {

    private final Handle handle;

    VulnerabilityDao(Handle handle) {
        this.handle = handle;
    }

    /**
     * Synchronizes multiple transient vulnerabilities with the database.
     * <p>
     * Note that vulnerabilities with {@link Vulnerability#getId()} already
     * populated are assumed to already exist in the desired state.
     * Their properties will <strong>not</strong> be synchronized.
     *
     * @param vulns              The {@link Vulnerability}s to synchronize.
     * @param canUpdatePredicate A {@link Predicate} that determines whether the invoker
     *                           of this method is allowed to update existing vulnerability
     *                           records of a given source. This is used to prevent non-authoritative
     *                           sources from overriding data from authoritative sources.
     * @return A {@link Map} keyed by {@link VulnerabilityKey} holding the respective database ID
     * of the persisted vulnerability.
     */
    Map<VulnerabilityKey, Long> syncAll(
            Collection<Vulnerability> vulns,
            Predicate<String> canUpdatePredicate) {
        final var results = new HashMap<VulnerabilityKey, Long>(vulns.size());

        // Process vulnerabilities with pre-populated ID first.
        // We might get lucky and won't have to call the DB at all!
        for (final Vulnerability vuln : vulns) {
            if (vuln.getId() > 0) {
                results.put(new VulnerabilityKey(vuln.getVulnId(), vuln.getSource()), vuln.getId());
            }
        }
        if (results.size() == vulns.size()) {
            return results;
        }

        // Partition remaining vulns by whether they're updatable as per predicate.
        // Read-only vulns can be resolved with a simple SELECT, avoiding exclusive row locks that the
        // upsert would acquire even when no actual update occurs.
        //
        // NB: This handles the common case where analyzers (e.g. OSS Index)
        // report CVEs, but CVEs are already mirrored from an authoritative source (i.e. NVD).
        // There is no point in submitting CVEs reported by OSSI for upsert then.
        final var vulnToQueryByVulnerabilityKey = new HashMap<VulnerabilityKey, Vulnerability>();
        final var vulnToUpsertByVulnerabilityKey = new HashMap<VulnerabilityKey, Vulnerability>();

        for (final Vulnerability vuln : vulns) {
            if (vuln.getId() > 0) {
                // We already dealt with these.
                continue;
            }

            if (canUpdatePredicate.test(vuln.getSource())) {
                vulnToUpsertByVulnerabilityKey.put(VulnerabilityKey.of(vuln), vuln);
            } else {
                vulnToQueryByVulnerabilityKey.put(VulnerabilityKey.of(vuln), vuln);
            }
        }

        if (!vulnToQueryByVulnerabilityKey.isEmpty()) {
            final Map<VulnerabilityKey, Long> resolved = resolveAll(vulnToQueryByVulnerabilityKey.keySet());
            results.putAll(resolved);

            for (final var entry : vulnToQueryByVulnerabilityKey.entrySet()) {
                final VulnerabilityKey VulnerabilityKey = entry.getKey();
                final Vulnerability vuln = entry.getValue();

                if (!resolved.containsKey(VulnerabilityKey)) {
                    // Doesn't exist yet, schedule for upsert.
                    vulnToUpsertByVulnerabilityKey.put(VulnerabilityKey, vuln);
                }
            }
        }

        if (vulnToUpsertByVulnerabilityKey.isEmpty()) {
            return results;
        }

        results.putAll(upsertAll(vulnToUpsertByVulnerabilityKey.values(), canUpdatePredicate));
        return results;
    }

    private Map<VulnerabilityKey, Long> resolveAll(Collection<VulnerabilityKey> VulnerabilityKeys) {
        if (VulnerabilityKeys.isEmpty()) {
            return Map.of();
        }

        final var vulnIds = new String[VulnerabilityKeys.size()];
        final var sources = new String[VulnerabilityKeys.size()];

        int i = 0;
        for (final var VulnerabilityKey : VulnerabilityKeys) {
            vulnIds[i] = VulnerabilityKey.vulnId();
            sources[i] = VulnerabilityKey.source().name();
            i++;
        }

        return handle
                .createQuery("""
                        WITH cte_input AS (
                          SELECT *
                            FROM UNNEST(:vulnIds, :sources)
                              AS t(vuln_id, source)
                        )
                        SELECT v."ID"
                             , v."VULNID"
                             , v."SOURCE"
                          FROM "VULNERABILITY" AS v
                         INNER JOIN cte_input AS i
                            ON v."VULNID" = i.vuln_id
                           AND v."SOURCE" = i.source
                        """)
                .bind("vulnIds", vulnIds)
                .bind("sources", sources)
                .map((rs, ctx) -> Map.entry(
                        new VulnerabilityKey(rs.getString("VULNID"), rs.getString("SOURCE")),
                        rs.getLong("ID")))
                .stream()
                .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));
    }

    private Map<VulnerabilityKey, Long> upsertAll(
            Collection<Vulnerability> vulns,
            Predicate<String> canUpdatePredicate) {
        if (vulns.isEmpty()) {
            return Map.of();
        }

        final int vulnsCount = vulns.size();
        final var vulnIds = new String[vulnsCount];
        final var sources = new String[vulnsCount];
        final var friendlyVulnIds = new String[vulnsCount];
        final var titles = new String[vulnsCount];
        final var subTitles = new String[vulnsCount];
        final var descriptions = new String[vulnsCount];
        final var details = new String[vulnsCount];
        final var recommendations = new String[vulnsCount];
        final var references = new String[vulnsCount];
        final var credits = new String[vulnsCount];
        final var createdArray = new Date[vulnsCount];
        final var publishedArray = new Date[vulnsCount];
        final var updatedArray = new Date[vulnsCount];
        final var cwesArray = new String[vulnsCount];
        final var cvssV2BaseScores = new Double[vulnsCount];
        final var cvssV2ImpactSubScores = new Double[vulnsCount];
        final var cvssV2ExploitabilitySubScores = new Double[vulnsCount];
        final var cvssV2Vectors = new String[vulnsCount];
        final var cvssV3BaseScores = new Double[vulnsCount];
        final var cvssV3ImpactSubScores = new Double[vulnsCount];
        final var cvssV3ExploitabilitySubScores = new Double[vulnsCount];
        final var cvssV3Vectors = new String[vulnsCount];
        final var cvssV4Scores = new Double[vulnsCount];
        final var cvssV4Vectors = new String[vulnsCount];
        final var owaspRRLikelihoodScores = new Double[vulnsCount];
        final var owaspRRTechnicalImpactScores = new Double[vulnsCount];
        final var owaspRRBusinessImpactScores = new Double[vulnsCount];
        final var owaspRRVectors = new String[vulnsCount];
        final var severities = new String[vulnsCount];
        final var vulnerableVersions = new String[vulnsCount];
        final var patchedVersions = new String[vulnsCount];
        final var canUpdateArray = new boolean[vulnsCount];

        int i = 0;
        for (final Vulnerability vuln : vulns) {
            vulnIds[i] = vuln.getVulnId();
            sources[i] = vuln.getSource();
            friendlyVulnIds[i] = vuln.getFriendlyVulnId();
            titles[i] = vuln.getTitle();
            subTitles[i] = vuln.getSubTitle();
            descriptions[i] = vuln.getDescription();
            details[i] = vuln.getDetail();
            recommendations[i] = vuln.getRecommendation();
            references[i] = vuln.getReferences();
            credits[i] = vuln.getCredits();
            createdArray[i] = vuln.getCreated();
            publishedArray[i] = vuln.getPublished();
            updatedArray[i] = vuln.getUpdated();
            cwesArray[i] = (vuln.getCwes() != null && !vuln.getCwes().isEmpty())
                    ? vuln.getCwes().stream().map(String::valueOf).collect(Collectors.joining(","))
                    : null;
            cvssV2BaseScores[i] = vuln.getCvssV2BaseScore() != null
                    ? vuln.getCvssV2BaseScore().doubleValue()
                    : null;
            cvssV2ImpactSubScores[i] = vuln.getCvssV2ImpactSubScore() != null
                    ? vuln.getCvssV2ImpactSubScore().doubleValue()
                    : null;
            cvssV2ExploitabilitySubScores[i] = vuln.getCvssV2ExploitabilitySubScore() != null
                    ? vuln.getCvssV2ExploitabilitySubScore().doubleValue()
                    : null;
            cvssV2Vectors[i] = vuln.getCvssV2Vector();
            cvssV3BaseScores[i] = vuln.getCvssV3BaseScore() != null
                    ? vuln.getCvssV3BaseScore().doubleValue()
                    : null;
            cvssV3ImpactSubScores[i] = vuln.getCvssV3ImpactSubScore() != null
                    ? vuln.getCvssV3ImpactSubScore().doubleValue()
                    : null;
            cvssV3ExploitabilitySubScores[i] = vuln.getCvssV3ExploitabilitySubScore() != null
                    ? vuln.getCvssV3ExploitabilitySubScore().doubleValue()
                    : null;
            cvssV3Vectors[i] = vuln.getCvssV3Vector();
            cvssV4Scores[i] = vuln.getCvssV4Score() != null
                    ? vuln.getCvssV4Score().doubleValue()
                    : null;
            cvssV4Vectors[i] = vuln.getCvssV4Vector();
            owaspRRLikelihoodScores[i] = vuln.getOwaspRRLikelihoodScore() != null
                    ? vuln.getOwaspRRLikelihoodScore().doubleValue()
                    : null;
            owaspRRTechnicalImpactScores[i] = vuln.getOwaspRRTechnicalImpactScore() != null
                    ? vuln.getOwaspRRTechnicalImpactScore().doubleValue()
                    : null;
            owaspRRBusinessImpactScores[i] = vuln.getOwaspRRBusinessImpactScore() != null
                    ? vuln.getOwaspRRBusinessImpactScore().doubleValue()
                    : null;
            owaspRRVectors[i] = vuln.getOwaspRRVector();
            severities[i] = vuln.getSeverity() != null
                    ? vuln.getSeverity().name()
                    : null;
            vulnerableVersions[i] = vuln.getVulnerableVersions();
            patchedVersions[i] = vuln.getPatchedVersions();
            canUpdateArray[i] = canUpdatePredicate.test(vuln.getSource());
            i++;
        }

        return handle
                .createQuery("""
                        WITH
                        cte_input AS (
                          SELECT vuln_id
                               , source
                               , friendly_vuln_id
                               , title
                               , sub_title
                               , description
                               , detail
                               , recommendation
                               , "references"
                               , credits
                               , created
                               , published
                               , updated
                               , cwes
                               , cvss_v2_base_score
                               , cvss_v2_impact_sub_score
                               , cvss_v2_exploitability_sub_score
                               , cvss_v2_vector
                               , cvss_v3_base_score
                               , cvss_v3_impact_sub_score
                               , cvss_v3_exploitability_sub_score
                               , cvss_v3_vector
                               , cvss_v4_score
                               , cvss_v4_vector
                               , owasp_rr_likelihood_score
                               , owasp_rr_technical_impact_score
                               , owasp_rr_business_impact_score
                               , owasp_rr_vector
                               , "severity"
                               , vulnerable_versions
                               , patched_versions
                               , can_update
                            FROM UNNEST (
                              :vulnIds
                            , :sources
                            , :friendlyVulnIds
                            , :titles
                            , :subTitles
                            , :descriptions
                            , :details
                            , :recommendations
                            , :references
                            , :credits
                            , :createdArray
                            , :publishedArray
                            , :updatedArray
                            , :cwesArray
                            , :cvssV2BaseScores
                            , :cvssV2ImpactSubScores
                            , :cvssV2ExploitabilitySubScores
                            , :cvssV2Vectors
                            , :cvssV3BaseScores
                            , :cvssV3ImpactSubScores
                            , :cvssV3ExploitabilitySubScores
                            , :cvssV3Vectors
                            , :cvssV4Scores
                            , :cvssV4Vectors
                            , :owaspRRLikelihoodScores
                            , :owaspRRTechnicalImpactScores
                            , :owaspRRBusinessImpactScores
                            , :owaspRRVectors
                            , :severities
                            , :vulnerableVersions
                            , :patchedVersions
                            , :canUpdateArray
                            ) AS t (
                              vuln_id
                            , source
                            , friendly_vuln_id
                            , title
                            , sub_title
                            , description
                            , detail
                            , recommendation
                            , "references"
                            , credits
                            , created
                            , published
                            , updated
                            , cwes
                            , cvss_v2_base_score
                            , cvss_v2_impact_sub_score
                            , cvss_v2_exploitability_sub_score
                            , cvss_v2_vector
                            , cvss_v3_base_score
                            , cvss_v3_impact_sub_score
                            , cvss_v3_exploitability_sub_score
                            , cvss_v3_vector
                            , cvss_v4_score
                            , cvss_v4_vector
                            , owasp_rr_likelihood_score
                            , owasp_rr_technical_impact_score
                            , owasp_rr_business_impact_score
                            , owasp_rr_vector
                            , "severity"
                            , vulnerable_versions
                            , patched_versions
                            , can_update
                            )
                        ),
                        cte_modified AS (
                          INSERT INTO "VULNERABILITY" AS v (
                            "VULNID"
                          , "SOURCE"
                          , "FRIENDLYVULNID"
                          , "TITLE"
                          , "SUBTITLE"
                          , "DESCRIPTION"
                          , "DETAIL"
                          , "RECOMMENDATION"
                          , "REFERENCES"
                          , "CREDITS"
                          , "CREATED"
                          , "PUBLISHED"
                          , "UPDATED"
                          , "CWES"
                          , "CVSSV2BASESCORE"
                          , "CVSSV2IMPACTSCORE"
                          , "CVSSV2EXPLOITSCORE"
                          , "CVSSV2VECTOR"
                          , "CVSSV3BASESCORE"
                          , "CVSSV3IMPACTSCORE"
                          , "CVSSV3EXPLOITSCORE"
                          , "CVSSV3VECTOR"
                          , "CVSSV4SCORE"
                          , "CVSSV4VECTOR"
                          , "OWASPRRLIKELIHOODSCORE"
                          , "OWASPRRTECHNICALIMPACTSCORE"
                          , "OWASPRRBUSINESSIMPACTSCORE"
                          , "OWASPRRVECTOR"
                          , "SEVERITY"
                          , "VULNERABLEVERSIONS"
                          , "PATCHEDVERSIONS"
                          , "UUID"
                          )
                          SELECT vuln_id
                               , source
                               , friendly_vuln_id
                               , title
                               , sub_title
                               , description
                               , detail
                               , recommendation
                               , "references"
                               , credits
                               , created
                               , published
                               , updated
                               , cwes
                               , cvss_v2_base_score
                               , cvss_v2_impact_sub_score
                               , cvss_v2_exploitability_sub_score
                               , cvss_v2_vector
                               , cvss_v3_base_score
                               , cvss_v3_impact_sub_score
                               , cvss_v3_exploitability_sub_score
                               , cvss_v3_vector
                               , cvss_v4_score
                               , cvss_v4_vector
                               , owasp_rr_likelihood_score
                               , owasp_rr_technical_impact_score
                               , owasp_rr_business_impact_score
                               , owasp_rr_vector
                               , CAST("severity" AS severity)
                               , vulnerable_versions
                               , patched_versions
                               , GEN_RANDOM_UUID()
                            FROM cte_input
                           ORDER BY vuln_id
                                  , source
                          ON CONFLICT ("VULNID", "SOURCE") DO UPDATE
                          SET "FRIENDLYVULNID" = EXCLUDED."FRIENDLYVULNID"
                            , "TITLE" = EXCLUDED."TITLE"
                            , "SUBTITLE" = EXCLUDED."SUBTITLE"
                            , "DESCRIPTION" = EXCLUDED."DESCRIPTION"
                            , "DETAIL" = EXCLUDED."DETAIL"
                            , "RECOMMENDATION" = EXCLUDED."RECOMMENDATION"
                            , "REFERENCES" = EXCLUDED."REFERENCES"
                            , "CREDITS" = EXCLUDED."CREDITS"
                            , "CREATED" = EXCLUDED."CREATED"
                            , "PUBLISHED" = EXCLUDED."PUBLISHED"
                            , "UPDATED" = EXCLUDED."UPDATED"
                            , "CWES" = EXCLUDED."CWES"
                            , "CVSSV2BASESCORE" = EXCLUDED."CVSSV2BASESCORE"
                            , "CVSSV2IMPACTSCORE" = EXCLUDED."CVSSV2IMPACTSCORE"
                            , "CVSSV2EXPLOITSCORE" = EXCLUDED."CVSSV2EXPLOITSCORE"
                            , "CVSSV2VECTOR" = EXCLUDED."CVSSV2VECTOR"
                            , "CVSSV3BASESCORE" = EXCLUDED."CVSSV3BASESCORE"
                            , "CVSSV3IMPACTSCORE" = EXCLUDED."CVSSV3IMPACTSCORE"
                            , "CVSSV3EXPLOITSCORE" = EXCLUDED."CVSSV3EXPLOITSCORE"
                            , "CVSSV3VECTOR" = EXCLUDED."CVSSV3VECTOR"
                            , "CVSSV4SCORE" = EXCLUDED."CVSSV4SCORE"
                            , "CVSSV4VECTOR" = EXCLUDED."CVSSV4VECTOR"
                            , "OWASPRRLIKELIHOODSCORE" = EXCLUDED."OWASPRRLIKELIHOODSCORE"
                            , "OWASPRRTECHNICALIMPACTSCORE" = EXCLUDED."OWASPRRTECHNICALIMPACTSCORE"
                            , "OWASPRRBUSINESSIMPACTSCORE" = EXCLUDED."OWASPRRBUSINESSIMPACTSCORE"
                            , "OWASPRRVECTOR" = EXCLUDED."OWASPRRVECTOR"
                            , "SEVERITY" = EXCLUDED."SEVERITY"
                            , "VULNERABLEVERSIONS" = EXCLUDED."VULNERABLEVERSIONS"
                            , "PATCHEDVERSIONS" = EXCLUDED."PATCHEDVERSIONS"
                          WHERE TRUE
                            -- Only update when allowed to.
                            AND EXISTS (
                                  SELECT 1
                                    FROM cte_input AS i
                                   WHERE i.vuln_id = v."VULNID"
                                     AND i.source = v."SOURCE"
                                     AND i.can_update
                                )
                            -- Only update when the incoming data is not older than the existing data.
                            AND (v."UPDATED" IS NULL OR EXCLUDED."UPDATED" > v."UPDATED")
                            -- Only update when any relevant field changed.
                            AND (
                                  v."FRIENDLYVULNID"
                                , v."TITLE"
                                , v."SUBTITLE"
                                , v."DESCRIPTION"
                                , v."DETAIL"
                                , v."RECOMMENDATION"
                                , v."REFERENCES"
                                , v."CREDITS"
                                , v."CREATED"
                                , v."PUBLISHED"
                                , v."UPDATED"
                                , v."CWES"
                                , v."CVSSV2BASESCORE"
                                , v."CVSSV2IMPACTSCORE"
                                , v."CVSSV2EXPLOITSCORE"
                                , v."CVSSV2VECTOR"
                                , v."CVSSV3BASESCORE"
                                , v."CVSSV3IMPACTSCORE"
                                , v."CVSSV3EXPLOITSCORE"
                                , v."CVSSV3VECTOR"
                                , v."CVSSV4SCORE"
                                , v."CVSSV4VECTOR"
                                , v."OWASPRRLIKELIHOODSCORE"
                                , v."OWASPRRTECHNICALIMPACTSCORE"
                                , v."OWASPRRBUSINESSIMPACTSCORE"
                                , v."OWASPRRVECTOR"
                                , v."SEVERITY"
                                , v."VULNERABLEVERSIONS"
                                , v."PATCHEDVERSIONS"
                                ) IS DISTINCT FROM (
                                  EXCLUDED."FRIENDLYVULNID"
                                , EXCLUDED."TITLE"
                                , EXCLUDED."SUBTITLE"
                                , EXCLUDED."DESCRIPTION"
                                , EXCLUDED."DETAIL"
                                , EXCLUDED."RECOMMENDATION"
                                , EXCLUDED."REFERENCES"
                                , EXCLUDED."CREDITS"
                                , EXCLUDED."CREATED"
                                , EXCLUDED."PUBLISHED"
                                , EXCLUDED."UPDATED"
                                , EXCLUDED."CWES"
                                , EXCLUDED."CVSSV2BASESCORE"
                                , EXCLUDED."CVSSV2IMPACTSCORE"
                                , EXCLUDED."CVSSV2EXPLOITSCORE"
                                , EXCLUDED."CVSSV2VECTOR"
                                , EXCLUDED."CVSSV3BASESCORE"
                                , EXCLUDED."CVSSV3IMPACTSCORE"
                                , EXCLUDED."CVSSV3EXPLOITSCORE"
                                , EXCLUDED."CVSSV3VECTOR"
                                , EXCLUDED."CVSSV4SCORE"
                                , EXCLUDED."CVSSV4VECTOR"
                                , EXCLUDED."OWASPRRLIKELIHOODSCORE"
                                , EXCLUDED."OWASPRRTECHNICALIMPACTSCORE"
                                , EXCLUDED."OWASPRRBUSINESSIMPACTSCORE"
                                , EXCLUDED."OWASPRRVECTOR"
                                , EXCLUDED."SEVERITY"
                                , EXCLUDED."VULNERABLEVERSIONS"
                                , EXCLUDED."PATCHEDVERSIONS"
                                )
                          RETURNING "VULNID"
                                  , "SOURCE"
                                  , "ID"
                        )
                        SELECT "VULNID"
                             , "SOURCE"
                             , "ID"
                          FROM cte_modified
                         UNION ALL
                        SELECT v."VULNID"
                             , v."SOURCE"
                             , v."ID"
                          FROM "VULNERABILITY" AS v
                         INNER JOIN cte_input AS i
                            ON i.vuln_id = v."VULNID"
                           AND i.source = v."SOURCE"
                         WHERE NOT EXISTS (
                                     SELECT 1
                                       FROM cte_modified AS m
                                      WHERE m."VULNID" = i.vuln_id
                                        AND m."SOURCE" = i.source
                                   )
                        """)
                .bind("vulnIds", vulnIds)
                .bind("sources", sources)
                .bind("friendlyVulnIds", friendlyVulnIds)
                .bind("titles", titles)
                .bind("subTitles", subTitles)
                .bind("descriptions", descriptions)
                .bind("details", details)
                .bind("recommendations", recommendations)
                .bind("references", references)
                .bind("credits", credits)
                .bind("createdArray", createdArray)
                .bind("publishedArray", publishedArray)
                .bind("updatedArray", updatedArray)
                .bind("cwesArray", cwesArray)
                .bind("cvssV2BaseScores", cvssV2BaseScores)
                .bind("cvssV2ImpactSubScores", cvssV2ImpactSubScores)
                .bind("cvssV2ExploitabilitySubScores", cvssV2ExploitabilitySubScores)
                .bind("cvssV2Vectors", cvssV2Vectors)
                .bind("cvssV3BaseScores", cvssV3BaseScores)
                .bind("cvssV3ImpactSubScores", cvssV3ImpactSubScores)
                .bind("cvssV3ExploitabilitySubScores", cvssV3ExploitabilitySubScores)
                .bind("cvssV3Vectors", cvssV3Vectors)
                .bind("cvssV4Scores", cvssV4Scores)
                .bind("cvssV4Vectors", cvssV4Vectors)
                .bind("owaspRRLikelihoodScores", owaspRRLikelihoodScores)
                .bind("owaspRRTechnicalImpactScores", owaspRRTechnicalImpactScores)
                .bind("owaspRRBusinessImpactScores", owaspRRBusinessImpactScores)
                .bind("owaspRRVectors", owaspRRVectors)
                .bind("severities", severities)
                .bind("vulnerableVersions", vulnerableVersions)
                .bind("patchedVersions", patchedVersions)
                .bind("canUpdateArray", canUpdateArray)
                .map((rs, ctx) -> Map.entry(
                        new VulnerabilityKey(rs.getString("VULNID"), rs.getString("SOURCE")),
                        rs.getLong("ID")))
                .collectToMap(Map.Entry::getKey, Map.Entry::getValue);
    }

}

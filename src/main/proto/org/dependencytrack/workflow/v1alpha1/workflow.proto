syntax = "proto3";

package org.dependencytrack.workflow.v1alpha1;

import "google/protobuf/any.proto";
import "google/protobuf/timestamp.proto";

option java_multiple_files = true;
option java_package = "org.dependencytrack.proto.workflow.v1alpha1";

message WorkflowEvent {
  // ID of the event.
  string id = 1;

  // ID of the workflow run.
  string workflow_run_id = 2;

  // When the event occurred.
  google.protobuf.Timestamp timestamp = 3;

  oneof subject {
    WorkflowRunRequested run_requested = 100;
    WorkflowRunQueued run_queued = 101;
    WorkflowRunStarted run_started = 102;
    WorkflowRunSuspended run_suspended = 103;
    WorkflowRunResumed run_resumed = 104;
    WorkflowRunCompleted run_completed = 105;
    WorkflowRunFailed run_failed = 106;

    WorkflowActivityRunRequested activity_run_requested = 200;
    WorkflowActivityRunQueued activity_run_queued = 201;
    WorkflowActivityRunStarted activity_run_started = 202;
    WorkflowActivityRunCompleted activity_run_completed = 203;
    WorkflowActivityRunFailed activity_run_failed = 204;

    ExternalEventAwaited external_event_awaited = 300;
    ExternalEventReceived external_event_received = 301;
  }
}

message WorkflowPayload {
  // Metadata describing the payload.
  map<string, bytes> metadata = 1;

  oneof content {
    bytes binary_content = 10;
    google.protobuf.Any proto_content = 11;
  }
}

message WorkflowRunRequested {
  // Name of the workflow to run.
  string name = 1;

  // Version of the workflow to run.
  int32 version = 2;

  // Priority of this run.
  optional int32 priority = 3;

  // Argument of the run.
  optional WorkflowPayload argument = 4;
}

message WorkflowRunQueued {
  // ID of the task executing the workflow.
  string task_id = 1;

  // Priority of this run.
  optional int32 priority = 2;

  // Argument of the run.
  optional WorkflowPayload argument = 3;
}

message WorkflowRunStarted {
  // ID of the task executing the workflow.
  string task_id = 1;

  // Attempt that was started.
  int32 attempt = 2;

  // Argument of the run.
  optional WorkflowPayload argument = 3;
}

message WorkflowRunSuspended {
  // ID of the task executing the workflow.
  string task_id = 1;

  // Attempt that was suspended.
  int32 attempt = 2;

  // IDs of completions the run is waiting for.
  repeated string awaited_completion_ids = 3;
}

message WorkflowRunResumed {
  // ID of the task executing the workflow.
  string task_id = 1;

  // Attempt that was resumed.
  int32 attempt = 2;
}

message WorkflowRunCompleted {
  // ID of the task executing the workflow.
  string task_id = 1;

  // Attempt that completed.
  int32 attempt = 2;

  // Result of the run.
  optional WorkflowPayload result = 3;
}

message WorkflowRunFailed {
  // ID of the task executing the workflow.
  string task_id = 1;

  int32 attempt = 2;

  // Whether the failure is terminal and can't be retried.
  bool is_terminal_failure = 3;

  // Details about the failure.
  string failure_details = 4;
}

message WorkflowActivityRunRequested {
  // ID of the completion.
  string completion_id = 1;

  // Name of the activity.
  string activity_name = 2;

  // ID of the invocation.
  string invocation_id = 3;

  // Argument of the activity run.
  optional WorkflowPayload argument = 4;

  // ID of the task that invoked this activity.
  string invoking_task_id = 5;
}

message WorkflowActivityRunQueued {
  // ID of the completion.
  string completion_id = 1;

  // ID of the task executing the activity.
  string task_id = 2;

  // Name of the activity.
  string activity_name = 4;

  // ID of the invocation.
  string invocation_id = 5;

  // Argument of the activity run.
  optional WorkflowPayload argument = 6;

  // ID of the task that invoked this activity.
  string invoking_task_id = 7;
}

message WorkflowActivityRunStarted {
  // ID of the completion.
  string completion_id = 1;

  // ID of the task executing the activity.
  // Not set when the activity is executed locally.
  optional string task_id = 2;

  // Name of the activity.
  string activity_name = 4;

  // ID of the invocation.
  string invocation_id = 5;

  // Attempt that was started.
  int32 attempt = 6;

  // Argument of the activity run.
  optional WorkflowPayload argument = 7;

  // Whether the activity is executed locally.
  bool is_local = 8;

  // ID of the task that invoked this activity.
  string invoking_task_id = 9;
}

message WorkflowActivityRunCompleted {
  // ID of the completion.
  string completion_id = 1;

  // ID of the task executing the activity.
  // Not set when the activity was executed locally.
  optional string task_id = 2;

  // Name of the activity.
  string activity_name = 4;

  // ID of the invocation.
  string invocation_id = 5;

  // Attempt that completed.
  int32 attempt = 6;

  // Result of the activity run.
  optional WorkflowPayload result = 7;

  // Whether the activity was executed locally.
  bool is_local = 8;

  // ID of the task that invoked this activity.
  string invoking_task_id = 9;
}

message WorkflowActivityRunFailed {
  // ID of the completion.
  string completion_id = 1;

  // ID of the task executing the activity.
  // Not set when the activity was executed locally.
  optional string task_id = 2;

  // Name of the activity.
  string activity_name = 4;

  // ID of the invocation.
  string invocation_id = 5;

  // Attempt that failed.
  int32 attempt = 6;

  // Whether the failure is terminal and can't be retried.
  bool is_terminal_failure = 7;

  // Details about the failure.
  string failure_details = 8;

  // Whether the activity is executed locally.
  bool is_local = 9;

  // ID of the task that invoked this activity.
  string invoking_task_id = 10;
}

message ExternalEventAwaited {
  // ID of the completion.
  string completion_id = 1;

  // ID of the external event to wait for.
  string external_event_id = 2;

  // ID of the task that is awaiting the event.
  string invoking_task_id = 3;
}

message ExternalEventReceived {
  // ID of the external event.
  string id = 1;

  // Content of the external event.
  optional WorkflowPayload payload = 2;
}
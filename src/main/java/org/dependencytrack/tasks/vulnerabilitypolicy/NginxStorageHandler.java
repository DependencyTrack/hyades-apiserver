package org.dependencytrack.tasks.vulnerabilitypolicy;

import alpine.common.logging.Logger;
import alpine.model.ConfigProperty;
import org.apache.http.Header;
import org.apache.http.HttpStatus;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.dependencytrack.model.ConfigPropertyConstants;
import org.dependencytrack.persistence.QueryManager;

import java.io.IOException;
import java.util.Arrays;
import java.util.Optional;

public class NginxStorageHandler extends AbstractVulnerabilityPolicyFetcher {

    private static final Logger LOGGER = Logger.getLogger(NginxStorageHandler.class);

    public NginxStorageHandler() {
        super.setUsername();
        super.setPassword();
    }

    @Override
    public boolean verifyDownloadNeeded() throws IOException {
        try (CloseableHttpResponse response = performHeadRequest()) {
            if (response.getStatusLine().getStatusCode() == HttpStatus.SC_OK) {
                Header[] httpHeaders = response.getAllHeaders();
                Optional<Header> headerOptional = Arrays.stream(httpHeaders).filter(header -> header.getName().equalsIgnoreCase("ETag")).findFirst();
                if (headerOptional.isPresent()) {
                    try (QueryManager queryManager = new QueryManager()) {
                        ConfigProperty lastModified = queryManager.getConfigProperty(ConfigPropertyConstants.VULNERABILITY_POLICY_POLICY_FILE_LAST_MODIFIED_HASH.getGroupName(),
                                ConfigPropertyConstants.VULNERABILITY_POLICY_POLICY_FILE_LAST_MODIFIED_HASH.getPropertyName());
                        if (lastModified == null) {
                            queryManager.createConfigProperty(ConfigPropertyConstants.VULNERABILITY_POLICY_POLICY_FILE_LAST_MODIFIED_HASH.getGroupName(),
                                    ConfigPropertyConstants.VULNERABILITY_POLICY_POLICY_FILE_LAST_MODIFIED_HASH.getPropertyName(),
                                    headerOptional.get().getValue(),
                                    ConfigPropertyConstants.VULNERABILITY_POLICY_POLICY_FILE_LAST_MODIFIED_HASH.getPropertyType(),
                                    ConfigPropertyConstants.VULNERABILITY_POLICY_POLICY_FILE_LAST_MODIFIED_HASH.getDescription());
                            return true;
                        }
                        else if (lastModified.getPropertyValue() == null) {
                            lastModified.setPropertyValue(headerOptional.get().getValue());
                            return true;
                        } else
                            return !(headerOptional.get().getValue().equals(lastModified.getPropertyValue()));
                    }
                } else {
                    LOGGER.warn("Was not able to find Etag header in the nginx request. Will proceed assuming that file needs to be downloaded");
                    return true;
                }
            } else if (response.getStatusLine().getStatusCode() == 304) {
                return false;
            } else {
                throw new IOException("Unable to get response from resource bundle endpoint for policy");

            }
        }
    }

}

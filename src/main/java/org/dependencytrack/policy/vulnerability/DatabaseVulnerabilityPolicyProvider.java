package org.dependencytrack.policy.vulnerability;

import alpine.persistence.PaginatedResult;
import alpine.resources.AlpineRequest;
import org.dependencytrack.persistence.Ordering;
import org.dependencytrack.persistence.QueryManager;
import org.dependencytrack.persistence.jdbi.VulnerabilityPolicyDao;
import org.dependencytrack.proto.policy.v1.Project;

import java.util.List;

import static org.dependencytrack.persistence.jdbi.JdbiFactory.jdbi;

public class DatabaseVulnerabilityPolicyProvider implements VulnerabilityPolicyProvider {

    @Override
    public List<VulnerabilityPolicy> getApplicablePolicies(final Project project) {
        try (final var qm = new QueryManager()) {
            return jdbi(qm).withExtension(VulnerabilityPolicyDao.class, VulnerabilityPolicyDao::getAllValid);
        }
    }

    @Override
    public PaginatedResult getAllVulnerabilityPolicies(AlpineRequest request) {
        try (final var qm = new QueryManager(request)) {
            return jdbi(qm).withExtension(VulnerabilityPolicyDao.class,
                    dao -> dao.getPageWithNameLike(new Ordering(request), request.getPagination(), request.getFilter()));
        }
    }

}

<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
        objectQuotingStrategy="QUOTE_ALL_OBJECTS"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="v5.6.0-roles-dev" author="pkwiatkowski1">
        <addColumn tableName="APIKEY">
            <column name="IS_LEGACY" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="PUBLIC_ID" type="VARCHAR(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <addUniqueConstraint columnNames="PUBLIC_ID" constraintName="APIKEY_PUBLIC_IDX" tableName="APIKEY"/>
    </changeSet>

    <changeSet id="v5.6.0-roles" author="jhoward-lm">
        <createTable ifNotExists="true" tableName="ROLE">
            <column autoIncrement="true" name="ID" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ROLE_PK" />
            </column>

            <column name="NAME" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="ROLE_NAME_IDX"
                    validateNullable="true" validateUnique="true" />
            </column>

            <column name="UUID" type="UUID">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="ROLE_UUID_IDX"
                    validateNullable="true" validateUnique="true" />
            </column>
        </createTable>

        <createTable ifNotExists="true" tableName="ROLES_PERMISSIONS">
            <column name="ROLE_ID" type="BIGINT">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="ROLES_PERMISSIONS_COMPOSITE_IDX"
                    foreignKeyName="ROLES_PERMISSIONS_ROLE_FK"
                    referencedTableName="ROLE" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="true"
                    validateUnique="true" validateForeignKey="true" />
            </column>

            <column name="PERMISSION_ID" type="BIGINT">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="ROLES_PERMISSIONS_COMPOSITE_IDX"
                    foreignKeyName="ROLES_PERMISSIONS_PERMISSION_FK"
                    referencedTableName="PERMISSION" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="true"
                    validateUnique="true" validateForeignKey="true" />
            </column>
        </createTable>

        <createIndex indexName="ROLES_PERMISSIONS_ROLE_ID_IDX" tableName="ROLES_PERMISSIONS">
            <column name="ROLE_ID" />
        </createIndex>

        <createIndex indexName="ROLES_PERMISSIONS_PERMISSION_ID_IDX" tableName="ROLES_PERMISSIONS">
            <column name="PERMISSION_ID" />
        </createIndex>

        <createTable ifNotExists="true" tableName="LDAPUSERS_PROJECTS_ROLES">
            <column name="LDAPUSER_ID" type="BIGINT">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="LDAPUSERS_PROJECTS_ROLES_COMPOSITE_IDX"
                    foreignKeyName="LDAPUSERS_PROJECTS_ROLES_LDAPUSER_FK"
                    referencedTableName="LDAPUSER" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="false"
                    validateUnique="true" validateForeignKey="true" />
            </column>

            <column name="PROJECT_ID" type="BIGINT">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="LDAPUSERS_PROJECTS_ROLES_COMPOSITE_IDX"
                    foreignKeyName="LDAPUSERS_PROJECTS_ROLES_PROJECT_FK"
                    referencedTableName="PROJECT" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="true"
                    validateUnique="true" validateForeignKey="true" />
            </column>

            <column name="ROLE_ID" type="BIGINT">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="LDAPUSERS_PROJECTS_ROLES_COMPOSITE_IDX"
                    foreignKeyName="LDAPUSERS_PROJECTS_ROLES_ROLE_FK"
                    referencedTableName="ROLE" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="true"
                    validateUnique="true" validateForeignKey="true" />
            </column>
        </createTable>

        <createIndex indexName="LDAPUSERS_PROJECTS_ROLES_LDAPUSER_ID_IDX" tableName="LDAPUSERS_PROJECTS_ROLES">
            <column name="LDAPUSER_ID" />
        </createIndex>

        <createIndex indexName="LDAPUSERS_PROJECTS_ROLES_PROJECT_ID_IDX" tableName="LDAPUSERS_PROJECTS_ROLES">
            <column name="PROJECT_ID" />
        </createIndex>

        <createIndex indexName="LDAPUSERS_PROJECTS_ROLES_ROLE_ID_IDX" tableName="LDAPUSERS_PROJECTS_ROLES">
            <column name="ROLE_ID" />
        </createIndex>

        <createTable ifNotExists="true" tableName="MANAGEDUSERS_PROJECTS_ROLES">
            <column name="MANAGEDUSER_ID" type="BIGINT">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="MANAGEDUSERS_PROJECTS_ROLES_COMPOSITE_IDX"
                    foreignKeyName="MANAGEDUSERS_PROJECTS_ROLES_MANAGEDUSER_FK"
                    referencedTableName="MANAGEDUSER" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="false"
                    validateUnique="true" validateForeignKey="true" />
            </column>

            <column name="PROJECT_ID" type="BIGINT">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="MANAGEDUSERS_PROJECTS_ROLES_COMPOSITE_IDX"
                    foreignKeyName="MANAGEDUSERS_PROJECTS_ROLES_PROJECT_FK"
                    referencedTableName="PROJECT" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="true"
                    validateUnique="true" validateForeignKey="true" />
            </column>

            <column name="ROLE_ID" type="BIGINT">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="MANAGEDUSERS_PROJECTS_ROLES_COMPOSITE_IDX"
                    foreignKeyName="MANAGEDUSERS_PROJECTS_ROLES_ROLE_FK"
                    referencedTableName="ROLE" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="true"
                    validateUnique="true" validateForeignKey="true" />
            </column>
        </createTable>

        <createIndex indexName="MANAGEDUSERS_PROJECTS_ROLES_MANAGEDUSER_ID_IDX" tableName="MANAGEDUSERS_PROJECTS_ROLES">
            <column name="MANAGEDUSER_ID" />
        </createIndex>

        <createIndex indexName="MANAGEDUSERS_PROJECTS_ROLES_PROJECT_ID_IDX" tableName="MANAGEDUSERS_PROJECTS_ROLES">
            <column name="PROJECT_ID" />
        </createIndex>

        <createIndex indexName="MANAGEDUSERS_PROJECTS_ROLES_ROLE_ID_IDX" tableName="MANAGEDUSERS_PROJECTS_ROLES">
            <column name="ROLE_ID" />
        </createIndex>

        <createTable ifNotExists="true" tableName="OIDCUSERS_PROJECTS_ROLES">
            <column name="OIDCUSER_ID" type="BIGINT">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="OIDCUSERS_PROJECTS_ROLES_COMPOSITE_IDX"
                    foreignKeyName="OIDCUSERS_PROJECTS_ROLES_OIDCUSER_FK"
                    referencedTableName="OIDCUSER" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="false" 
                    validateUnique="true" validateForeignKey="true" />
            </column>

            <column name="PROJECT_ID" type="BIGINT">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="OIDCUSERS_PROJECTS_ROLES_COMPOSITE_IDX"
                    foreignKeyName="OIDCUSERS_PROJECTS_ROLES_PROJECT_FK"
                    referencedTableName="PROJECT" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="true"
                    validateUnique="true" validateForeignKey="true" />
            </column>

            <column name="ROLE_ID" type="BIGINT">
                <constraints nullable="false" unique="true"
                    uniqueConstraintName="OIDCUSERS_PROJECTS_ROLES_COMPOSITE_IDX"
                    foreignKeyName="OIDCUSERS_PROJECTS_ROLES_ROLE_FK"
                    referencedTableName="ROLE" referencedColumnNames="ID"
                    deferrable="true" initiallyDeferred="true" deleteCascade="true"
                    validateUnique="true" validateForeignKey="true" />
            </column>
        </createTable>

        <createIndex indexName="OIDCUSERS_PROJECTS_ROLES_OIDCUSER_ID_IDX" tableName="OIDCUSERS_PROJECTS_ROLES">
            <column name="OIDCUSER_ID" />
        </createIndex>

        <createIndex indexName="OIDCUSERS_PROJECTS_ROLES_PROJECT_ID_IDX" tableName="OIDCUSERS_PROJECTS_ROLES">
            <column name="PROJECT_ID" />
        </createIndex>

        <createIndex indexName="OIDCUSERS_PROJECTS_ROLES_ROLE_ID_IDX" tableName="OIDCUSERS_PROJECTS_ROLES">
            <column name="ROLE_ID" />
        </createIndex>

        <createView viewName="USER_PROJECT_EFFECTIVE_PERMISSIONS" replaceIfExists="true">
            SELECT
                lpr."LDAPUSER_ID"    AS "LDAPUSER_ID",
                mpr."MANAGEDUSER_ID" AS "MANAGEDUSER_ID",
                opr."OIDCUSER_ID"    AS "OIDCUSER_ID",
                pr."ID"              AS "PROJECT_ID",
                p."ID"               AS "PERMISSION_ID",
                p."NAME"             AS "PERMISSION_NAME"
              FROM "PERMISSION" p
             INNER JOIN "ROLES_PERMISSIONS" rp
                ON rp."PERMISSION_ID" = p."ID"
              FULL OUTER JOIN "LDAPUSERS_PROJECTS_ROLES" lpr
                ON lpr."ROLE_ID" = rp."ROLE_ID"
              FULL OUTER JOIN "MANAGEDUSERS_PROJECTS_ROLES" mpr
                ON lpr."PROJECT_ID" = mpr."PROJECT_ID"
               AND lpr."ROLE_ID" = mpr."ROLE_ID"
              FULL OUTER JOIN "OIDCUSERS_PROJECTS_ROLES" opr
                ON mpr."PROJECT_ID" = opr."PROJECT_ID"
               AND mpr."ROLE_ID" = opr."ROLE_ID"
             INNER JOIN "PROJECT" pr
                ON lpr."PROJECT_ID" = pr."ID"
                OR mpr."PROJECT_ID" = pr."ID"
                OR opr."PROJECT_ID" = pr."ID"
        </createView>
    </changeSet>
</databaseChangeLog>

<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
        objectQuotingStrategy="QUOTE_ALL_OBJECTS"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext
            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
            http://www.liquibase.org/xml/ns/dbchangelog
            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">
    <changeSet id="v5.5.0-1" author="nscuro@protonmail.com">
        <addColumn tableName="APIKEY">
            <column name="COMMENT" type="VARCHAR(255)"/>
            <column name="CREATED" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="LAST_USED" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
    </changeSet>

    <changeSet id="v5.5.0-2" author="nscuro@protonmail.com">
        <dropIndex tableName="AFFECTEDVERSIONATTRIBUTION" indexName="AFFECTEDVERSIONATTRIBUTION_VULNERABILITY_IDX"/>
        <dropIndex tableName="AFFECTEDVERSIONATTRIBUTION" indexName="AFFECTEDVERSIONATTRIBUTION_VULNERABLE_SOFTWARE_IDX"/>
        <dropIndex tableName="ANALYSIS" indexName="ANALYSIS_PROJECT_ID_IDX"/>
        <dropIndex tableName="COMPONENTS_VULNERABILITIES" indexName="COMPONENTS_VULNERABILITIES_COMPONENT_ID_IDX"/>
        <dropIndex tableName="DEPENDENCYMETRICS" indexName="DEPENDENCYMETRICS_PROJECT_ID_IDX"/>
        <dropIndex tableName="FINDINGATTRIBUTION" indexName="FINDINGATTRIBUTION_COMPONENT_ID_IDX"/>
        <dropIndex tableName="INTEGRITY_META_COMPONENT" indexName="PURL_IDX"/>
        <dropUniqueConstraint tableName="INTEGRITY_META_COMPONENT" constraintName="INTEGRITY_META_COMPONENT_U1"/>
        <dropIndex tableName="MAPPEDLDAPGROUP" indexName="MAPPEDLDAPGROUP_TEAM_ID_IDX"/>
        <dropIndex tableName="MAPPEDOIDCGROUP" indexName="MAPPEDOIDCGROUP_TEAM_ID_IDX"/>
        <dropIndex tableName="PROJECT_PROPERTY" indexName="PROJECT_PROPERTY_PROJECT_ID_IDX"/>
        <dropIndex tableName="VIOLATIONANALYSIS" indexName="VIOLATIONANALYSIS_PROJECT_ID_IDX"/>
        <dropIndex tableName="VULNERABILITY" indexName="VULNERABILITY_VULNID_IDX"/>
        <dropIndex tableName="VULNERABLESOFTWARE" indexName="VULNERABLESOFTWARE_PART_VENDOR_PRODUCT_IDX"/>

        <createIndex tableName="INTEGRITY_META_COMPONENT" indexName="INTEGRITY_META_COMPONENT_PURL_IDX" unique="true">
            <column name="PURL"/>
        </createIndex>
    </changeSet>

    <changeSet id="v5.5.0-3" author="sahibamittal">
        <addColumn tableName="BOM">
            <column name="GENERATED" type="TIMESTAMP WITH TIME ZONE"/>
        </addColumn>
    </changeSet>

    <changeSet id="v5.5.0-4" author="sahibamittal">
        <dropColumn tableName="VULNERABILITY">
            <column name="EPSSSCORE" type="numeric"/>
            <column name="EPSSPERCENTILE" type="numeric"/>
        </dropColumn>
        <createTable tableName="EPSS">
            <column autoIncrement="true" name="ID" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="EPSS_CVE_PK"/>
            </column>
            <column name="CVE" type="TEXT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="PERCENTILE" type="numeric"/>
            <column name="SCORE" type="numeric"/>
        </createTable>
        <createIndex indexName="EPSS_CVE_IDX" tableName="EPSS" unique="true">
            <column name="CVE"/>
        </createIndex>
    </changeSet>
</databaseChangeLog>
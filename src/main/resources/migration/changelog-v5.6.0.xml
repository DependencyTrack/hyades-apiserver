<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
        objectQuotingStrategy="QUOTE_ALL_OBJECTS"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="v5.6.0-1" author="sahibamittal">
        <modifyDataType tableName="AFFECTEDVERSIONATTRIBUTION" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="BOM" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="COMPONENT" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="COMPONENT_PROPERTY" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="FINDINGATTRIBUTION" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="LICENSE" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="LICENSEGROUP" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="NOTIFICATIONPUBLISHER" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="NOTIFICATIONRULE" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="POLICY" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="POLICYCONDITION" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="POLICYVIOLATION" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="PROJECT" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="REPOSITORY" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="SERVICECOMPONENT" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="VEX" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="VULNERABILITY" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="VULNERABILITYALIAS" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="VULNERABILITYSCAN" columnName="TARGET_IDENTIFIER" newDataType="UUID"/>
        <modifyDataType tableName="VULNERABILITYSCAN" columnName="TOKEN" newDataType="UUID"/>
        <modifyDataType tableName="VULNERABLESOFTWARE" columnName="UUID" newDataType="UUID"/>
        <modifyDataType tableName="WORKFLOW_STATE" columnName="TOKEN" newDataType="UUID"/>
    </changeSet>

    <changeSet id="v5.6.0-2" author="nscuro">
        <modifyDataType tableName="TEAM" columnName="NAME" newDataType="VARCHAR(255)"/>
    </changeSet>
  
    <changeSet id="v5.6.0-3" author="rossmurphy974@gmail.com">
        <addColumn tableName="PROJECT">
            <column name="AUTHORS" type="TEXT"/>
        </addColumn>
        <addColumn tableName="COMPONENT">
            <column name="AUTHORS" type="TEXT"/>
        </addColumn>
        
        <sql>
            UPDATE "PROJECT"
            SET "AUTHORS" = JSON_BUILD_ARRAY(JSON_BUILD_OBJECT('name', "AUTHOR"))::TEXT
            WHERE "AUTHOR" IS NOT NULL;
        </sql>
        <sql>
            UPDATE "COMPONENT"
            SET "AUTHORS" = JSON_BUILD_ARRAY(JSON_BUILD_OBJECT('name', "AUTHOR"))::TEXT
            WHERE "AUTHOR" IS NOT NULL;
        </sql>

        <dropColumn tableName="PROJECT">
            <column name="AUTHOR"/>
        </dropColumn>
        <dropColumn tableName="COMPONENT">
            <column name="AUTHOR"/>
        </dropColumn>
    </changeSet>
    
    <changeSet id="v5.6.0-4" author="nscuro">
        <dropIndex tableName="COMPONENT" indexName="COMPONENT_DIRECT_DEPENDENCIES_GIN_IDX"/>
        <modifyDataType tableName="COMPONENT" columnName="DIRECT_DEPENDENCIES" newDataType="JSONB"/>
        <modifyDataType tableName="PROJECT" columnName="DIRECT_DEPENDENCIES" newDataType="JSONB"/>
        <sql splitStatements="true">
            CREATE
             INDEX "COMPONENT_DIRECT_DEPENDENCIES_JSONB_IDX"
                ON "COMPONENT"
             USING GIN("DIRECT_DEPENDENCIES" JSONB_PATH_OPS);
        </sql>
    </changeSet>

    <changeSet id="v5.6.0-5" author="sahibamittal">
        <sql>
            DELETE FROM "CONFIGPROPERTY"
            WHERE "GROUPNAME" = 'artifact'
            AND "PROPERTYNAME" = 'bom.validation.enabled';
        </sql>
    </changeSet>

    <changeSet id="v5.6.0-6" author="sahibamittal">
        <createTable tableName="NOTIFICATIONRULE_TAGS">
            <column name="NOTIFICATIONRULE_ID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="TAG_ID" type="BIGINT"/>
        </createTable>

        <createIndex indexName="NOTIFICATIONRULE_TAGS_NOTIFICATIONRULE_ID_IDX" tableName="NOTIFICATIONRULE_TAGS">
            <column name="NOTIFICATIONRULE_ID"/>
        </createIndex>
        <createIndex indexName="NOTIFICATIONRULE_TAGS_TAG_ID_IDX" tableName="NOTIFICATIONRULE_TAGS">
            <column name="TAG_ID"/>
        </createIndex>

        <addForeignKeyConstraint baseColumnNames="NOTIFICATIONRULE_ID" baseTableName="NOTIFICATIONRULE_TAGS"
                                 constraintName="NOTIFICATIONRULE_TAGS_NOTIFICATIONRULE_FK" deferrable="true" initiallyDeferred="true"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="ID"
                                 referencedTableName="NOTIFICATIONRULE" validate="true"/>

        <addForeignKeyConstraint baseColumnNames="TAG_ID" baseTableName="NOTIFICATIONRULE_TAGS"
                                 constraintName="NOTIFICATIONRULE_TAGS_TAG_FK" deferrable="true" initiallyDeferred="true"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="ID"
                                 referencedTableName="TAG" validate="true"/>
    </changeSet>

    <changeSet id="v5.6.0-7" author="n1ckl0sk0rtge">
        <sql splitStatements="true">
            ALTER TABLE "COMPONENT" DROP CONSTRAINT IF EXISTS "COMPONENT_CLASSIFIER_check";
            ALTER TABLE "COMPONENT" ADD CONSTRAINT "COMPONENT_CLASSIFIER_check"
                CHECK ("CLASSIFIER" IS NULL OR "CLASSIFIER"::TEXT = ANY(ARRAY['APPLICATION', 'CONTAINER', 'DEVICE', 'FILE', 'FIRMWARE', 'FRAMEWORK', 'LIBRARY', 'OPERATING_SYSTEM', 'CRYPTOGRAPHIC_ASSET']));

            ALTER TABLE "PROJECT" DROP CONSTRAINT IF EXISTS "PROJECT_CLASSIFIER_check";
            ALTER TABLE "PROJECT" ADD CONSTRAINT "PROJECT_CLASSIFIER_check"
                CHECK ("CLASSIFIER" IS NULL OR "CLASSIFIER"::TEXT = ANY(ARRAY['APPLICATION', 'CONTAINER', 'DEVICE', 'FILE', 'FIRMWARE', 'FRAMEWORK', 'LIBRARY', 'OPERATING_SYSTEM', 'CRYPTOGRAPHIC_ASSET']));
        </sql>
    </changeSet>

    <changeSet id="v5.6.0-8" author="san-zrl">
        <addColumn tableName="COMPONENT">
            <column name="CRYPTO_PROPERTIES_ID" type="BIGINT"/>
        </addColumn>

        <createTable tableName="CRYPTO_PROPERTIES">
            <column autoIncrement="true" name="ID" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="CRYPTO_PROPERTIES_PK"/>
            </column>
            <column name="ASSET_TYPE" type="VARCHAR(32)"/>
            <column name="ALGORITHM_PROPERTIES_ID" type="BIGINT"/>
            <column name="CERTIFICATE_PROPERTIES_ID" type="BIGINT"/>
            <column name="RELATED_MATERIAL_PROPERTIES_ID" type="BIGINT"/>
            <column name="PROTOCOL_PROPERTIES_ID" type="BIGINT"/>
            <column name="OID" type="VARCHAR(255)"/>
        </createTable>

        <createTable tableName="ALGORITHM_PROPERTIES">
            <column autoIncrement="true" name="ID" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ALGORITHM_PROPERTIES_PK"/>
            </column>
            <column name="PRIMITIVE" type="VARCHAR(32)"/>
            <column name="PARAMETER_SET_ID" type="VARCHAR(32)"/>
            <column name="CURVE" type="VARCHAR(32)"/>
            <column name="EXECUTION_ENV" type="VARCHAR(32)"/>
            <column name="IMPLEMENTATION_PLATFORM" type="VARCHAR(32)"/>
            <column name="CERTIFICATION_LEVEL" type="VARCHAR(32)"/>
            <column name="MODE" type="VARCHAR(16)"/>
            <column name="PADDING" type="VARCHAR(16)"/>
            <column name="CRYPTO_FUNCTIONS" type="TEXT[]"/>
            <column name="CLASSICAL_SECURITY_LEVEL" type="INT"/>
            <column name="NIST_QUANTUM_SECURITY_LEVEL" type="INT"/>
        </createTable>

        <createTable tableName="CERTIFICATE_PROPERTIES">
            <column autoIncrement="true" name="ID" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="CERTIFICATE_PROPERTIES_PK"/>
            </column>
            <column name="SUBJECT_NAME" type="VARCHAR(255)"/>
            <column name="ISSUER_NAME" type="VARCHAR(255)"/>
            <column name="NOT_VALID_BEFORE" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="NOT_VALID_AFTER" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="SIGNATURE_ALGORITHM_REF" type="VARCHAR(64)"/>
            <column name="SUBJECT_PUBLIC_KEY_REF" type="VARCHAR(64)"/>
            <column name="CERTIFICATE_FORMAT" type="VARCHAR(32)"/>
            <column name="CERTIFICATE_EXTENSION" type="VARCHAR(32)"/>
        </createTable>

        <createTable tableName="RELATED_CRYPTO_MATERIAL_PROPERTIES">
            <column autoIncrement="true" name="ID" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="RELATED_CRYPTO_MATERIAL_PROPERTIES_PK"/>
            </column>
            <column name="TYPE" type="VARCHAR(32)"/>
            <column name="IDENTIFIER" type="VARCHAR(64)"/>
            <column name="STATE" type="VARCHAR(16)"/>
            <column name="ALGORITHM_REF" type="VARCHAR(64)"/>
            <column name="CREATION_DATE" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="ACTIVATION_DATE" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="UPDATE_DATE" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="EXPIRATION_DATE" type="TIMESTAMP WITH TIME ZONE"/>
            <column name="VALUE" type="VARCHAR(32)"/>
            <column name="SIZE" type="INT"/>
            <column name="FORMAT" type="VARCHAR(8)"/>
            <column name="SECURED_BY_ID" type="BIGINT"/>
        </createTable>

        <createTable tableName="SECURED_BY">
            <column autoIncrement="true" name="ID" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="SECURED_BY_PK"/>
            </column>
            <column name="MECHANISM" type="VARCHAR(16)"/>
            <column name="ALGORITHM_REF" type="VARCHAR(64)"/>
        </createTable>

        <createTable tableName="PROTOCOL_PROPERTIES">
            <column autoIncrement="true" name="ID" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="PROTOCOL_PROPERTIES_PK"/>
            </column>
            <column name="TYPE" type="VARCHAR(16)"/>
            <column name="VERSION" type="VARCHAR(16)"/>
             <column name="CRYPTO_REFS" type="TEXT[]"/>
        </createTable>

        <createTable tableName="PROTOCOL_CIPHER_SUITES">
            <column name="PROTOCOL_PROPERTY_ID" type="BIGINT"/>
            <column name="CIPHER_SUITE_ID" type="BIGINT"/>
        </createTable>

        <createTable tableName="CIPHER_SUITE">
            <column autoIncrement="true" name="ID" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="CIPHER_SUITE_PK"/>
            </column>
            <column name="NAME" type="VARCHAR(64)"/>
            <column name="ALGORITHMS" type="TEXT[]"/>
            <column name="IDENTIFIERS" type="TEXT[]"/>
        </createTable>

        <createTable tableName="PROTOCOL_IKEV2_TYPES">
            <column name="PROTOCOL_PROPERTY_ID" type="BIGINT"/>
            <column name="IKEV2_TYPE_ID" type="BIGINT"/>
        </createTable>

        <createTable tableName="IKEV2_TYPE">
            <column autoIncrement="true" name="ID" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="IKEV2_TYPE_PK"/>
            </column>
            <column name="TYPE" type="VARCHAR(16)"/>
            <column name="REFS" type="TEXT[]"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="COMPONENT" baseColumnNames="CRYPTO_PROPERTIES_ID"
                                 constraintName="COMPONENT_CRYPTO_PROPERTIES_FK" deferrable="true" initiallyDeferred="true"
                                 referencedTableName="CRYPTO_PROPERTIES" referencedColumnNames="ID"
                                 onDelete="CASCADE" onUpdate="NO ACTION" validate="true"/>
        <addForeignKeyConstraint baseTableName="CRYPTO_PROPERTIES" baseColumnNames="ALGORITHM_PROPERTIES_ID"
                                 constraintName="CRYPTO_PROPERTIES_ALGORITHM_FK" deferrable="true" initiallyDeferred="true"
                                 referencedTableName="ALGORITHM_PROPERTIES" referencedColumnNames="ID"
                                 onDelete="CASCADE" onUpdate="NO ACTION" validate="true"/>
        <addForeignKeyConstraint baseTableName="CRYPTO_PROPERTIES" baseColumnNames="CERTIFICATE_PROPERTIES_ID"
                                 constraintName="CRYPTO_PROPERTIES_CERTIFICATE_FK" deferrable="true" initiallyDeferred="true"
                                 referencedTableName="CERTIFICATE_PROPERTIES" referencedColumnNames="ID"
                                 onDelete="CASCADE" onUpdate="NO ACTION" validate="true"/>
        <addForeignKeyConstraint baseTableName="CRYPTO_PROPERTIES" baseColumnNames="RELATED_MATERIAL_PROPERTIES_ID"
                                 constraintName="CRYPTO_PROPERTIES_RELATED_MATERIAL_FK" deferrable="true" initiallyDeferred="true"
                                 referencedTableName="RELATED_CRYPTO_MATERIAL_PROPERTIES" referencedColumnNames="ID"
                                 onDelete="CASCADE" onUpdate="NO ACTION" validate="true"/>
        <addForeignKeyConstraint baseTableName="CRYPTO_PROPERTIES" baseColumnNames="PROTOCOL_PROPERTIES_ID"
                                 constraintName="CRYPTO_PROPERTIES_PROTOCOL_FK" deferrable="true" initiallyDeferred="true"
                                 referencedTableName="PROTOCOL_PROPERTIES" referencedColumnNames="ID"
                                 onDelete="CASCADE" onUpdate="NO ACTION" validate="true"/>
    </changeSet>

    <changeSet id="v5.6.0-9" author="n1ckl0sk0rtge">
        <createTable tableName="CRYPTOGRAPHYMETRICS">
            <column autoIncrement="true" name="ID" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="CRYPTOGRAPHYMETRICS_PK"/>
            </column>
            <column name="NUMBER_OF_CRYPTOGRAPHIC_ASSETS" type="INTEGER"/>
            <column name="MOST_USED_ALGORITHM_NAME" type="VARCHAR(255)"/>
            <column name="MOST_USED_ALGORITHM_PERCENTAGE" type="DOUBLE"/>
            <column name="NUMBER_OF_KEYS" type="INTEGER"/>
            <column name="FIRST_OCCURRENCE" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column name="LAST_OCCURRENCE" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
</databaseChangeLog>
/*
 * This file is part of Dependency-Track.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 * Copyright (c) OWASP Foundation. All Rights Reserved.
 */
package org.dependencytrack.util;

import org.dependencytrack.PersistenceCapableTest;
import org.dependencytrack.model.ConfigPropertyConstants;
import org.dependencytrack.persistence.jdbi.VulnerabilityPolicyDao;
import org.dependencytrack.policy.vulnerability.VulnerabilityPolicy;
import org.dependencytrack.policy.vulnerability.VulnerabilityPolicyOperation;
import org.junit.Test;
import org.junit.jupiter.api.Assertions;
import org.projectnessie.cel.tools.ScriptCreateException;
import org.projectnessie.cel.tools.ScriptException;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.dependencytrack.persistence.jdbi.JdbiFactory.withJdbiHandle;
import static org.junit.Assert.assertEquals;

public class VulnerabilityPolicyUtilTest extends PersistenceCapableTest {

    @Test
    public void testParseVulnerabilityPolicy() throws ScriptCreateException, IOException {
        String out = """
                apiVersion: v1.0
                type: Vulnerability Policy
                name: Example2
                description: Foo bar
                author: Jane Doe
                validFrom: 2024-01-01T00:00:00Z
                validUntil: 2024-01-01T00:00:00Z
                conditions:
                  - vuln.id == "CVE-125" || vuln.aliases.exists(alias, alias.id == "CVE-123")
                  - |-
                    vuln.id == "CVE-156" || vuln.aliases.exists(alias, alias.id == "CVE-156")
                analysis:
                  state: NOT_AFFECTED
                  justification: CODE_NOT_REACHABLE
                  details: Because foo bar baz
                  suppress: true
                  vendorResponse: CAN_NOT_FIX
                ratings:
                  - method: CVSSV3
                    vector: CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: MEDIUM
                    score: 6.3
                  - method: CVSSV2
                    vector: CVSS:2.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: HIGH
                    score: 8.3
                operationMode: APPLY
                """;
        List<VulnerabilityPolicy> createVulnerabilityPolicyList = new ArrayList<>();
        List<VulnerabilityPolicy> updateVulnerabilityPolicyList = new ArrayList<>();
        List<String> policyNames = new ArrayList<>();
        VulnerabilityPolicyUtil.parseVulnerabilityPolicy(out, createVulnerabilityPolicyList,
                updateVulnerabilityPolicyList, policyNames);
        Assertions.assertEquals(1, createVulnerabilityPolicyList.size());
    }

    @Test
    public void testParseVulnerabilityPolicyInvalid() throws ScriptCreateException, IOException {
        String out = """
                apiVersion: v1.0
                type: Vulnerability Policy
                name: Example2
                description: Foo bar
                author: Jane Doe
                validFrom: 2024-01-01T00:00:00Z
                validUntil: 2024-01-01T00:00:00Z
                conditions:
                  - vuln.id == "CVE-125" | vuln.aliases.exists(alias, alias.id == "CVE-123")
                  - |-
                    vuln.id == "CVE-156" | vuln.aliases.exists(alias, alias.id == "CVE-156")
                analysis:
                  state: NOT_AFFECTED
                  justification: CODE_NOT_REACHABLE
                  details: Because foo bar baz
                  suppress: true
                  vendorResponse: CAN_NOT_FIX
                ratings:
                  - method: CVSSV3
                    vector: CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: MEDIUM
                    score: 6.3
                  - method: CVSSV2
                    vector: CVSS:2.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: HIGH
                    score: 8.3
                operationMode: APPLY
                """;
        List<VulnerabilityPolicy> createVulnerabilityPolicyList = new ArrayList<>();
        List<VulnerabilityPolicy> updateVulnerabilityPolicyList = new ArrayList<>();
        List<String> policyNames = new ArrayList<>();

        Assertions.assertThrows(ScriptException.class, () -> VulnerabilityPolicyUtil.parseVulnerabilityPolicy(out, createVulnerabilityPolicyList,
                updateVulnerabilityPolicyList, policyNames));
    }

    @Test
    public void testmatchWithHashConfigPropertyNull() {
        Assertions.assertTrue(VulnerabilityPolicyUtil.matchWithHashConfigProperty("test"));
    }

    @Test
    public void testmatchWithHashConfigPropertyDifferentValue() {
        qm.createConfigProperty(ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getGroupName(),
                ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getPropertyName(),
                "test1",
                ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getPropertyType(),
                ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getDescription());
        Assertions.assertTrue(VulnerabilityPolicyUtil.matchWithHashConfigProperty("test"));
    }

    @Test
    public void testmatchWithEtagNullValue() {
        qm.createConfigProperty(ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getGroupName(),
                ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getPropertyName(),
                "test1",
                ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getPropertyType(),
                ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getDescription());
        Assertions.assertTrue(VulnerabilityPolicyUtil.matchWithHashConfigProperty(null));
    }

    @Test
    public void testmatchWithHashConfigPropertySameValue() {
        qm.createConfigProperty(ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getGroupName(),
                ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getPropertyName(),
                "test",
                ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getPropertyType(),
                ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getDescription());
        Assertions.assertFalse(VulnerabilityPolicyUtil.matchWithHashConfigProperty("test"));
    }

    @Test
    public void testmatchWithHashConfigPropertyNullValue() {
        qm.createConfigProperty(ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getGroupName(),
                ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getPropertyName(),
                null,
                ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getPropertyType(),
                ConfigPropertyConstants.VULNERABILITY_POLICY_FILE_LAST_MODIFIED_HASH.getDescription());
        Assertions.assertTrue(VulnerabilityPolicyUtil.matchWithHashConfigProperty("test"));
    }

    @Test
    public void testSaveParsedVulnerabilities() throws ScriptCreateException, IOException {
        String out = """
                apiVersion: v1.0
                type: Vulnerability Policy
                name: Example2
                description: Foo bar
                author: Jane Doe
                validFrom: 2024-01-01T00:00:00Z
                validUntil: 2024-01-01T00:00:00Z
                conditions:
                  - vuln.id == "CVE-125" || vuln.aliases.exists(alias, alias.id == "CVE-123")
                  - |-
                    vuln.id == "CVE-156" || vuln.aliases.exists(alias, alias.id == "CVE-156")
                analysis:
                  state: NOT_AFFECTED
                  justification: CODE_NOT_REACHABLE
                  details: Because foo bar baz
                  suppress: true
                  vendorResponse: CAN_NOT_FIX
                ratings:
                  - method: CVSSV3
                    vector: CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: MEDIUM
                    score: 6.3
                  - method: CVSSV2
                    vector: CVSS:2.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: HIGH
                    score: 8.3
                """;
        List<VulnerabilityPolicy> createVulnerabilityPolicyList = new ArrayList<>();
        List<VulnerabilityPolicy> updateVulnerabilityPolicyList = new ArrayList<>();
        List<String> policyNames = new ArrayList<>();
        VulnerabilityPolicyUtil.parseVulnerabilityPolicy(out, createVulnerabilityPolicyList,
                updateVulnerabilityPolicyList, policyNames);
        VulnerabilityPolicyUtil.saveParsedVulnerabilities(createVulnerabilityPolicyList, updateVulnerabilityPolicyList, policyNames);

        List<VulnerabilityPolicy> savedPolicies = withJdbiHandle(handle -> handle.attach(VulnerabilityPolicyDao.class).getAll());
        Assertions.assertEquals(1, savedPolicies.size());

        // Since 5.5.0: Default to operation mode APPLY if the policy does not explicit set one.
        assertThat(savedPolicies).satisfiesExactly(policy ->
                assertThat(policy.getOperationMode()).isEqualTo(VulnerabilityPolicyOperation.APPLY));
    }

    @Test
    public void updateVulnerabilityPolicyTest() throws ScriptCreateException, IOException {
        String out = """
                apiVersion: v1.0
                type: Vulnerability Policy
                name: Example2
                description: Foo bar
                author: Jane Doe
                validFrom: 2024-01-01T00:00:00Z
                validUntil: 2024-01-01T00:00:00Z
                conditions:
                  - vuln.id == "CVE-125" || vuln.aliases.exists(alias, alias.id == "CVE-123")
                  - |-
                    vuln.id == "CVE-156" || vuln.aliases.exists(alias, alias.id == "CVE-156")
                analysis:
                  state: NOT_AFFECTED
                  justification: CODE_NOT_REACHABLE
                  details: Because foo bar baz
                  suppress: true
                  vendorResponse: CAN_NOT_FIX
                ratings:
                  - method: CVSSV3
                    vector: CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: MEDIUM
                    score: 6.3
                  - method: CVSSV2
                    vector: CVSS:2.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: HIGH
                    score: 8.3
                operationMode: APPLY
                """;
        var createVulnerabilityPolicyList = new ArrayList<VulnerabilityPolicy>();
        var updateVulnerabilityPolicyList = new ArrayList<VulnerabilityPolicy>();
        var policyNames = new ArrayList<String>();
        VulnerabilityPolicyUtil.parseVulnerabilityPolicy(out, createVulnerabilityPolicyList, updateVulnerabilityPolicyList, policyNames);
        VulnerabilityPolicyUtil.saveParsedVulnerabilities(createVulnerabilityPolicyList, updateVulnerabilityPolicyList, policyNames);
        createVulnerabilityPolicyList = new ArrayList<>();
        policyNames.add("Example2");
        out = """
                apiVersion: v1.0
                type: Vulnerability Policy
                name: Example2
                description: Foo bar
                author: Jane Doe
                validFrom: 2024-01-01T00:00:00Z
                validUntil: 2024-01-01T00:00:00Z
                conditions:
                  - vuln.id == "CVE-125" || vuln.aliases.exists(alias, alias.id == "CVE-123")
                  - |-
                    vuln.id == "CVE-156" || vuln.aliases.exists(alias, alias.id == "CVE-156")
                analysis:
                  state: NOT_AFFECTED
                  justification: CODE_NOT_REACHABLE
                  details: Because foo bar baz
                  suppress: true
                  vendorResponse: UPDATE
                ratings:
                  - method: CVSSV3
                    vector: CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: MEDIUM
                    score: 7.5
                  - method: CVSSV2
                    vector: CVSS:2.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: HIGH
                    score: 8.3
                operationMode: LOG
                """;
        VulnerabilityPolicyUtil.parseVulnerabilityPolicy(out, createVulnerabilityPolicyList, updateVulnerabilityPolicyList, policyNames);
        VulnerabilityPolicyUtil.saveParsedVulnerabilities(createVulnerabilityPolicyList, updateVulnerabilityPolicyList, policyNames);
        assertEquals(1, updateVulnerabilityPolicyList.size());
        var updatedPolicy =withJdbiHandle(handle -> handle.attach(VulnerabilityPolicyDao.class).getByName("Example2"));
        assertEquals(Double.valueOf(7.5), updatedPolicy.getRatings().getFirst().getScore());
        assertEquals(VulnerabilityPolicyOperation.LOG, updatedPolicy.getOperationMode());
    }

    @Test
    public void deleteVulnerabilityPolicyTest() throws ScriptCreateException, IOException {
        String out = """
                apiVersion: v1.0
                type: Vulnerability Policy
                name: Example2
                description: Foo bar
                author: Jane Doe
                validFrom: 2024-01-01T00:00:00Z
                validUntil: 2024-01-01T00:00:00Z
                conditions:
                  - vuln.id == "CVE-125" || vuln.aliases.exists(alias, alias.id == "CVE-123")
                  - |-
                    vuln.id == "CVE-156" || vuln.aliases.exists(alias, alias.id == "CVE-156")
                analysis:
                  state: NOT_AFFECTED
                  justification: CODE_NOT_REACHABLE
                  details: Because foo bar baz
                  suppress: true
                  vendorResponse: CAN_NOT_FIX
                ratings:
                  - method: CVSSV3
                    vector: CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: MEDIUM
                    score: 6.3
                  - method: CVSSV2
                    vector: CVSS:2.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: HIGH
                    score: 8.3
                operationMode: APPLY
                """;
        String out1 = """
                apiVersion: v1.0
                type: Vulnerability Policy
                name: Example
                description: Foo bar
                author: Jane Doe
                validFrom: 2024-01-01T00:00:00Z
                validUntil: 2024-01-01T00:00:00Z
                conditions:
                  - vuln.id == "CVE-125" || vuln.aliases.exists(alias, alias.id == "CVE-123")
                  - |-
                    vuln.id == "CVE-156" || vuln.aliases.exists(alias, alias.id == "CVE-156")
                analysis:
                  state: NOT_AFFECTED
                  justification: CODE_NOT_REACHABLE
                  details: Because foo bar baz
                  suppress: true
                  vendorResponse: CAN_NOT_FIX
                ratings:
                  - method: CVSSV3
                    vector: CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: MEDIUM
                    score: 6.3
                  - method: CVSSV2
                    vector: CVSS:2.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: HIGH
                    score: 8.3
                operationMode: APPLY
                """;
        var createVulnerabilityPolicyList = new ArrayList<VulnerabilityPolicy>();
        var updateVulnerabilityPolicyList = new ArrayList<VulnerabilityPolicy>();
        var policyNames = new ArrayList<String>();
        VulnerabilityPolicyUtil.parseVulnerabilityPolicy(out, createVulnerabilityPolicyList, updateVulnerabilityPolicyList, policyNames);
        VulnerabilityPolicyUtil.saveParsedVulnerabilities(createVulnerabilityPolicyList, updateVulnerabilityPolicyList, policyNames);
        createVulnerabilityPolicyList = new ArrayList<>();
        VulnerabilityPolicyUtil.parseVulnerabilityPolicy(out1, createVulnerabilityPolicyList, updateVulnerabilityPolicyList, policyNames);
        VulnerabilityPolicyUtil.saveParsedVulnerabilities(createVulnerabilityPolicyList, updateVulnerabilityPolicyList, policyNames);
        policyNames.add("Example2");
        policyNames.add("Example");
        out = """
                apiVersion: v1.0
                type: Vulnerability Policy
                name: Example2
                description: Foo bar
                author: Jane Doe
                validFrom: 2024-01-01T00:00:00Z
                validUntil: 2024-01-01T00:00:00Z
                conditions:
                  - vuln.id == "CVE-125" || vuln.aliases.exists(alias, alias.id == "CVE-123")
                  - |-
                    vuln.id == "CVE-156" || vuln.aliases.exists(alias, alias.id == "CVE-156")
                analysis:
                  state: NOT_AFFECTED
                  justification: CODE_NOT_REACHABLE
                  details: Because foo bar baz
                  suppress: true
                  vendorResponse: UPDATE
                ratings:
                  - method: CVSSV3
                    vector: CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: MEDIUM
                    score: 7.5
                  - method: CVSSV2
                    vector: CVSS:2.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L
                    severity: HIGH
                    score: 8.3
                operationMode: APPLY
                """;
        createVulnerabilityPolicyList = new ArrayList<>();
        VulnerabilityPolicyUtil.parseVulnerabilityPolicy(out, createVulnerabilityPolicyList, updateVulnerabilityPolicyList, policyNames);
        VulnerabilityPolicyUtil.saveParsedVulnerabilities(createVulnerabilityPolicyList, updateVulnerabilityPolicyList, policyNames);
        assertEquals(1, withJdbiHandle(handle -> handle.attach(VulnerabilityPolicyDao.class).getAll()).size());
        assertEquals(Double.valueOf(7.5), withJdbiHandle(handle -> handle.attach(VulnerabilityPolicyDao.class).getByName("Example2")).getRatings().getFirst().getScore());
    }

}

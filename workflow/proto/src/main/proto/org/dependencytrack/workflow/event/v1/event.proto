/*
 * This file is part of Dependency-Track.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 * Copyright (c) OWASP Foundation. All Rights Reserved.
 */
syntax = "proto3";

package org.dependencytrack.workflow.event.v1;

import "google/protobuf/timestamp.proto";
import "org/dependencytrack/workflow/common/v1/common.proto";
import "org/dependencytrack/workflow/failure/v1/failure.proto";
import "org/dependencytrack/workflow/payload/v1/payload.proto";

option java_multiple_files = true;
option java_package = "org.dependencytrack.proto.workflow.event.v1";

message Event {
  int32 id = 1;

  google.protobuf.Timestamp timestamp = 2;

  oneof subject {
    ExecutionStarted execution_started = 25;
    ExecutionCompleted execution_completed = 26;

    RunScheduled run_scheduled = 50;
    RunStarted run_started = 51;
    RunCanceled run_canceled = 52;
    RunSuspended run_suspended = 53;
    RunResumed run_resumed = 54;
    RunCompleted run_completed = 55;

    ActivityTaskScheduled activity_task_scheduled = 75;
    ActivityTaskCompleted activity_task_completed = 76;
    ActivityTaskFailed activity_task_failed = 77;

    ChildRunScheduled child_run_scheduled = 100;
    ChildRunCompleted child_run_completed = 101;
    ChildRunFailed child_run_failed = 102;

    TimerScheduled timer_scheduled = 125;
    TimerElapsed timer_elapsed = 126;

    SideEffectExecuted side_effect_executed = 150;

    ExternalEventReceived external_event_received = 151;
  }
}

message ExecutionStarted {
}

message ExecutionCompleted {
}

message RunScheduled {
  string workflow_name = 1;
  int32 workflow_version = 2;
  optional org.dependencytrack.workflow.payload.v1.Payload argument = 3;
  optional string concurrency_group_id = 4;
  optional int32 priority = 5;
  map<string, string> labels = 6;
  optional ParentRun parent_run = 7;

  message ParentRun {
    int32 child_run_scheduled_event_id = 1;
    string run_id = 2;
    string workflow_name = 3;
    int32 workflow_version = 4;
  }
}

message RunStarted {
}

message RunCanceled {
  string reason = 1;
}

message RunSuspended {
}

message RunResumed {
}

message RunCompleted {
  org.dependencytrack.workflow.common.v1.WorkflowRunStatus status = 1;
  optional string custom_status = 2;
  optional org.dependencytrack.workflow.payload.v1.Payload result = 3;
  optional org.dependencytrack.workflow.failure.v1.Failure failure = 4;
}

message ActivityTaskScheduled {
  string name = 1;
  int32 version = 2;
  optional int32 priority = 3;
  optional org.dependencytrack.workflow.payload.v1.Payload argument = 4;
  optional google.protobuf.Timestamp scheduled_for = 5;
}

message ActivityTaskCompleted {
  int32 task_scheduled_event_id = 1;
  optional org.dependencytrack.workflow.payload.v1.Payload result = 2;
}

message ActivityTaskFailed {
  int32 task_scheduled_event_id = 1;
  org.dependencytrack.workflow.failure.v1.Failure failure = 2;
}

message ChildRunScheduled {
  string run_id = 1;
  string workflow_name = 2;
  int32 workflow_version = 3;
  optional string concurrency_group_id = 4;
  optional int32 priority = 5;
  map<string, string> labels = 6;
  optional org.dependencytrack.workflow.payload.v1.Payload argument = 7;
}

message ChildRunCompleted {
  int32 run_scheduled_event_id = 1;
  optional org.dependencytrack.workflow.payload.v1.Payload result = 2;
}

message ChildRunFailed {
  int32 run_scheduled_event_id = 1;
  org.dependencytrack.workflow.failure.v1.Failure failure = 2;
}

message TimerScheduled {
  string name = 1;
  google.protobuf.Timestamp elapse_at = 2;
}

message TimerElapsed {
  int32 timer_scheduled_event_id = 1;
  google.protobuf.Timestamp elapse_at = 2;
}

message SideEffectExecuted {
  int32 side_effect_event_id = 1;
  string name = 2;
  optional org.dependencytrack.workflow.payload.v1.Payload result = 3;
}

message ExternalEventReceived {
  string id = 1;
  optional org.dependencytrack.workflow.payload.v1.Payload payload = 2;
}